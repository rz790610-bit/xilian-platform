# 西联平台 — 接入层协议全面审计报告

## 一、审计范围与方法

本次审计覆盖接入层的全部 15 个协议适配器、前端配置界面（AccessLayerManager）、后端 tRPC 路由（accessLayer.router.ts）、服务层（access-layer.service.ts）、数据库 Schema（data_connectors / data_endpoints / data_bindings）以及协议注册中心（index.ts）。审计从**工业环境可用性**角度出发，检查每个环节的完整度、可靠性和配置灵活性。

---

## 二、协议适配器总览

### 2.1 适配器清单与基础指标

| 协议 | 文件 | 行数 | 配置字段 | TLS | 超时 | 重连 | 连接池 | NPM 依赖 |
|------|------|------|----------|-----|------|------|--------|----------|
| MQTT | mqtt.adapter.ts | 322 | 26 | ✅(12) | ✅(13) | ✅(3) | — | mqtt |
| OPC-UA | opcua.adapter.ts | 332 | 27 | ⚠(2) | ✅(4) | ✅(2) | — | node-opcua |
| Modbus | modbus.adapter.ts | 306 | 20 | ⚠(1) | ✅(4) | ✅(1) | — | modbus-serial |
| MySQL | mysql.adapter.ts | 305 | 29 | ✅(15) | ✅(7) | — | ✅(3) | mysql2 |
| PostgreSQL | postgresql.adapter.ts | 288 | 24 | ✅(20) | ✅(8) | — | ✅(6) | pg |
| ClickHouse | clickhouse.adapter.ts | 257 | 20 | ✅(4) | ✅(3) | — | — | @clickhouse/client |
| InfluxDB | influxdb.adapter.ts | 253 | 17 | ⚠(1) | ✅(3) | ✅(3) | — | @influxdata/influxdb-client |
| Redis | redis.adapter.ts | 335 | 25 | ✅(13) | ✅(15) | ✅(3) | — | ioredis |
| Neo4j | neo4j.adapter.ts | 296 | 18 | ✅(7) | ✅(5) | ✅(2) | ✅(2) | neo4j-driver |
| Qdrant | qdrant.adapter.ts | 227 | 12 | ⚠(1) | ✅(3) | ✅(2) | — | @qdrant/js-client-rest |
| Kafka | kafka.adapter.ts | 317 | 36 | ✅(14) | ✅(6) | ✅(5) | — | kafkajs |
| MinIO | minio.adapter.ts | 273 | 17 | ✅(5) | ⚠(1) | — | — | minio |
| HTTP | http.adapter.ts | 392 | 43 | ✅(6) | ✅(6) | ✅(3) | — | node:http/https |
| gRPC | grpc.adapter.ts | 316 | 32 | ✅(19) | ✅(3) | ✅(4) | — | @grpc/grpc-js |
| WebSocket | websocket.adapter.ts | 360 | 33 | ✅(11) | ✅(13) | ✅(5) | — | ws |

### 2.2 核心方法实现覆盖

所有 15 个适配器均实现了 BaseAdapter 要求的三个核心抽象方法：

| 方法 | 覆盖率 | 说明 |
|------|--------|------|
| `doTestConnection` | 15/15 (100%) | 全部真实建立连接并返回诊断信息 |
| `doDiscoverResources` | 15/15 (100%) | 全部实现远端资源发现 |
| `doHealthCheck` | 15/15 (100%) | 部分独立实现，部分复用 testConnection |

### 2.3 configSchema 三层结构覆盖

所有适配器均实现了 `connectionFields` / `authFields` / `advancedFields` 三层配置结构：

- **connectionFields**：必填的连接参数（主机、端口、协议版本等）
- **authFields**：认证配置（用户名密码、TLS 证书、API Key 等）
- **advancedFields**：高级调优参数（超时、重连、QoS、缓冲等）

---

## 三、审计发现 — 需修复项

### 3.1 严重级别（影响功能可用性）

| # | 问题 | 影响范围 | 修复方案 |
|---|------|----------|----------|
| S1 | **前端缺少"加载演示数据"按钮** — 后端有 `seedDemoData` API 但前端未暴露入口 | 新用户无法快速体验接入层功能 | 在 AccessLayerManager 概览 Tab 添加"加载演示数据"按钮 |
| S2 | **前端缺少"批量健康检查"功能** — 只能逐个点击检查 | 连接器数量多时操作繁琐 | 在连接器列表顶部添加"全部检查"按钮 |
| S3 | **无定时自动健康巡检** — healthCheckConfig 中的 interval 字段被存储但未被消费 | 连接器状态不会自动更新 | 添加 connectorHealthCheck.job.ts 定时巡检 |

### 3.2 中等级别（影响工业环境适用性）

| # | 问题 | 影响范围 | 修复方案 |
|---|------|----------|----------|
| M1 | **高级配置字段的 group 分组未在前端渲染** — 后端定义了 group（如 TLS/LWT/性能），但前端 advancedFields 渲染时未按 group 分组 | 高级配置项混在一起，可读性差 | DynamicFormField 区域按 group 分组渲染 |
| M2 | **InfluxDB/Qdrant/MinIO 缺少 TLS 配置字段** — TLS 引用次数仅 1 次（仅 useHttps boolean），缺少证书配置 | 生产环境无法使用 mTLS | 补充 caCert/clientCert/clientKey 字段 |
| M3 | **EndpointDialog 功能过于简单** — 仅展示端点列表，无法创建/编辑/删除端点，无法配置采样参数 | 资源发现后无法精细化管理端点 | 增强 EndpointDialog 支持 CRUD 和采样配置 |
| M4 | **连接器创建后无自动连接测试** — 创建连接器后状态为 draft，需手动点击测试 | 工业环境期望创建即验证 | 创建连接器后自动触发 testConnection |
| M5 | **Modbus 适配器缺少从站自动扫描** — doDiscoverResources 只扫描固定范围，不支持多从站自动发现 | 现场设备地址未知时无法自动发现 | 利用 scanSlaveIds 配置实现多从站扫描 |

### 3.3 轻微级别（改进体验）

| # | 问题 | 影响范围 | 修复方案 |
|---|------|----------|----------|
| L1 | **PEM 证书字段使用 type: 'string'** — CA 证书、客户端证书等长文本用单行 Input 渲染 | 粘贴 PEM 证书不方便 | 对含 "Cert"/"Key"/"PEM" 的字段自动渲染为 textarea |
| L2 | **连接器卡片缺少协议版本信息** — 测试连接返回的 serverVersion 未持久化 | 运维人员无法快速查看远端服务版本 | testConnection 成功后将 serverVersion 存入 metadata |
| L3 | **缺少连接器导入/导出功能** — 无法批量导入连接器配置 | 多环境部署时需手动重建 | 添加 JSON 导入/导出 API |
| L4 | **资源发现结果未自动创建端点** — 发现后仅返回列表，需手动创建 | 操作步骤多 | 发现后提供"一键导入"按钮 |

---

## 四、已有优势（无需修改）

以下方面经审计确认实现良好，符合工业环境要求：

1. **BaseAdapter 基础设施完善** — 统一错误分类（8 种 AdapterErrorCode）、指数退避重试、超时控制、连接池、运行指标收集，架构成熟。

2. **错误自动分类** — `normalizeError` 函数自动识别 ECONNREFUSED/ETIMEDOUT/AUTH 等模式并分类为对应的 AdapterErrorCode，区分可恢复/不可恢复错误。

3. **协议注册中心** — `index.ts` 统一注册所有 15 个适配器，`getRegisteredProtocols()` / `getAdapter()` / `getAllAdapterMetrics()` / `adapterCategories` 提供完整的查询接口。

4. **前端动态表单渲染** — `DynamicFormField` 组件支持 string/number/boolean/select/password/json 六种字段类型，根据 configSchema 自动渲染。

5. **三级数据模型** — Connector → Endpoint → Binding 模型清晰，数据库表设计合理，索引覆盖查询热路径。

6. **tRPC 路由完整** — CRUD + testConnection + healthCheck + discoverEndpoints + protocolSchemas + listProtocols + listCategories，端点齐全。

7. **NPM 依赖全部安装** — 16 个协议客户端库均已安装，均为各协议的主流/官方推荐库。

8. **演示数据丰富** — seedDemoData 创建了 6 个连接器（MQTT/OPC-UA/Modbus/ClickHouse/Kafka/MinIO）及对应端点和绑定，覆盖工业场景。

---

## 五、修复优先级排序

| 优先级 | 编号 | 修复项 | 预估工作量 |
|--------|------|--------|-----------|
| P0 | S3 | 连接器定时健康巡检 Job | 中 |
| P0 | S1 | 前端加载演示数据按钮 | 小 |
| P0 | S2 | 批量健康检查按钮 | 小 |
| P1 | M1 | 高级配置 group 分组渲染 | 小 |
| P1 | M3 | EndpointDialog 增强 | 中 |
| P1 | M4 | 创建连接器后自动测试 | 小 |
| P1 | L1 | PEM 证书字段 textarea 渲染 | 小 |
| P2 | M2 | InfluxDB/Qdrant/MinIO TLS 字段补充 | 小 |
| P2 | M5 | Modbus 多从站扫描 | 中 |
| P2 | L2 | serverVersion 持久化 | 小 |
| P2 | L4 | 资源发现一键导入 | 中 |
| P3 | L3 | 连接器导入/导出 | 中 |

---

## 六、审计结论

接入层协议的**架构设计和基础设施层（BaseAdapter / 连接池 / 错误体系 / 注册中心）实现质量高**，15 个协议适配器全部具备真实连接测试、资源发现和健康检查能力，configSchema 配置字段覆盖面广，NPM 依赖完整。

主要差距集中在**前端交互层**和**自动化运维**：
- 前端缺少演示数据入口、批量操作、高级配置分组渲染、端点精细化管理
- 后端缺少定时健康巡检机制（healthCheckConfig.interval 未被消费）
- 部分协议的 TLS 配置不够完整

建议按优先级排序执行修复，预计 P0+P1 修复后即可满足工业环境的基本可用性要求。
