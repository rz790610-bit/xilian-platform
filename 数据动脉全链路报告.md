# 数据动脉全链路实施报告

**版本**: v4.0  
**提交**: `1edf7ae`  
**日期**: 2026-02-19  
**新增代码**: 4,483 行 / 17 个文件

---

## 一、全链路架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        数据动脉全链路                                │
│                                                                     │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐   │
│  │  边缘网关     │    │  Kafka       │    │  特征提取服务         │   │
│  │              │    │              │    │                      │   │
│  │  MQTT ──────────→ telemetry.raw ───→ VibrationExtractor    │   │
│  │  HTTP ──────────→   (按网关分区) │    │  ScalarExtractor     │   │
│  │  WebSocket ─────→              │    │  ElectricalExtractor  │   │
│  │  gRPC ──────────→              │    │  RotationExtractor    │   │
│  │  OPC-UA ────────→              │    │  AcousticExtractor    │   │
│  │  Modbus ────────→              │    │  VisualExtractor      │   │
│  └──────────────┘    └──────────────┘    └──────────┬───────────┘   │
│                                                      │              │
│                      ┌──────────────┐                │              │
│                      │  Kafka       │                │              │
│                      │              │←───────────────┘              │
│                      │ telemetry.   │                               │
│                      │  feature.*   │                               │
│                      └──────┬───────┘                               │
│                             │                                       │
│  ┌──────────────────────────▼──────────────────────────────────┐    │
│  │  ClickHouse                                                  │    │
│  │                                                              │    │
│  │  realtime_telemetry (MergeTree, 原始+特征值)                  │    │
│  │       ↓ 物化视图                                              │    │
│  │  telemetry_1min_agg   (1分钟聚合)                             │    │
│  │  telemetry_1hour_agg  (1小时聚合)                             │    │
│  │  telemetry_daily_agg  (日聚合)                                │    │
│  │  device_daily_stats   (设备日统计)                             │    │
│  │  anomaly_detection_results (异常检测结果)                      │    │
│  └──────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、新增文件清单

| 文件 | 行数 | 职责 |
|------|------|------|
| `docker/clickhouse/init/03_realtime_telemetry.sql` | 267 | ClickHouse 时序表结构（MergeTree + Kafka Engine + 物化视图） |
| `server/services/telemetryClickhouseSink.service.ts` | 568 | Kafka→ClickHouse 消费者（批量写入/背压/去重/重试） |
| `server/services/data-artery.bootstrap.ts` | 226 | 数据动脉启动编排器（分层启动/优雅关闭/健康监控） |
| `server/services/gateway-kafka-bridge.service.ts` | 750 | 网关→Kafka 桥接（多协议接入） |
| `server/services/feature-extraction/types.ts` | 369 | 特征提取器基类和类型定义 |
| `server/services/feature-extraction/dsp-utils.ts` | 625 | DSP 工具库（FFT/窗函数/MFCC/谐波分析） |
| `server/services/feature-extraction/extractor-registry.ts` | 297 | 提取器注册表和路由器 |
| `server/services/feature-extraction/feature-extraction.service.ts` | 421 | 特征提取服务主入口 |
| `server/services/feature-extraction/index.ts` | 90 | 模块导出 |
| `server/services/feature-extraction/extractors/vibration.extractor.ts` | 107 | 振动特征提取器（FFT/RMS/峰值/峭度/包络） |
| `server/services/feature-extraction/extractors/scalar.extractor.ts` | 134 | 标量特征提取器（温度/压力/流量统计） |
| `server/services/feature-extraction/extractors/electrical.extractor.ts` | 105 | 电气特征提取器（谐波/THD/功率因数） |
| `server/services/feature-extraction/extractors/rotation.extractor.ts` | 154 | 旋转特征提取器（阶次分析/轴心轨迹） |
| `server/services/feature-extraction/extractors/acoustic.extractor.ts` | 151 | 声学特征提取器（MFCC/SPL/频谱质心） |
| `server/services/feature-extraction/extractors/visual.extractor.ts` | 219 | 视觉特征提取器（热成像/推理代理） |

---

## 三、各层详细设计

### 3.1 ClickHouse 时序表（Layer 0 — 存储层）

**核心设计决策**：

| 特性 | 实现 |
|------|------|
| 引擎 | MergeTree（按 device_code + mp_code + timestamp 排序） |
| 分区 | 按月分区（`toYYYYMM(timestamp)`），支持高效的时间范围查询和 TTL 清理 |
| 压缩 | value/raw_value 使用 `Delta + ZSTD(1)`，features 使用 `ZSTD(3)` |
| 索引 | Bloom Filter 索引（gateway_id, batch_id），加速等值查询 |
| TTL | 原始数据 180 天，1min 聚合 365 天，1hour 聚合 3 年，日聚合 10 年 |
| Kafka 消费 | Kafka Engine 表 + 物化视图自动写入，零代码消费 `telemetry.feature.*` |
| 聚合 | 三级物化视图（1min/1hour/daily），自动计算 min/max/avg/count |
| 兼容 | V1 旧表兼容视图（`v1_sensor_readings_compat`），旧代码无需修改 |

### 3.2 网关→Kafka 桥接（Layer 1 — 接入层）

**多协议支持**：

| 协议 | 实现方式 | 适用场景 |
|------|----------|----------|
| MQTT | 订阅 `gw/{gatewayId}/telemetry/#` | 标准 IoT 设备 |
| HTTP | POST `/api/gateway/{gatewayId}/telemetry` | REST 兼容设备 |
| WebSocket | 长连接双向通信 | 实时性要求高的场景 |
| gRPC | 流式 RPC | 高吞吐量场景 |
| OPC-UA | 预留接口 | 工业自动化设备 |
| Modbus | 预留接口 | 传统工业设备 |

**关键特性**：
- 统一消息格式（`GatewayTelemetryMessage`），所有协议归一化后写入 `telemetry.raw`
- 网关认证（API Key / 证书），防止未授权接入
- 消息验证（JSON Schema），拒绝格式错误的数据
- 按网关 ID 分区，保证同一网关的数据有序
- 批量发送（100条/500ms），减少 Kafka 写入开销

### 3.3 特征提取服务（Layer 2 — 处理层）

**可插拔提取器框架**：

```
FeatureExtractionService
  ├── ExtractorRegistry（注册表 — 按 data_type 路由）
  │     ├── VibrationExtractor    — FFT/RMS/峰值/峭度/主频/包络/倒频谱
  │     ├── ScalarExtractor       — 均值/方差/趋势斜率/突变检测/偏移量
  │     ├── ElectricalExtractor   — 谐波THD/功率因数/不平衡度/基波幅值
  │     ├── RotationExtractor     — 频率跟踪/阶次分析/轴心轨迹/间隙变化
  │     ├── AcousticExtractor     — MFCC/频谱质心/声压级/异常音纹
  │     └── VisualExtractor       — 温度分布/热点检测/缺陷区域（委托推理服务）
  ├── DSP 工具库（纯 TypeScript）
  │     ├── FFT（Cooley-Tukey 基2算法）
  │     ├── 窗函数（Hanning/Hamming/Blackman/Kaiser）
  │     ├── 频谱分析（功率谱/包络谱/倒频谱）
  │     ├── MFCC（梅尔频率倒谱系数）
  │     └── 谐波提取（基频检测/THD 计算）
  └── 启发式类型推断（无 data_type 时自动判断）
```

**关键特性**：
- 运行时热替换提取器（`registry.register()`）
- 支持自定义提取器（实现 `IFeatureExtractor` 接口）
- 批量处理（100条/批），减少 Kafka 读写开销
- 提取失败时原始数据直通（不丢数据）
- 每个提取器独立的质量评分（`quality_score`）

### 3.4 Kafka→ClickHouse 消费者（Layer 3 — 写入层）

| 特性 | 实现 |
|------|------|
| 批量写入 | 5,000 条/批 或 1 秒定时刷写 |
| 背压控制 | 缓冲区 50,000 上限，满时暂停 Kafka 消费 |
| 去重 | 基于 `device_code:mp_code:timestamp` 的内存去重集合 |
| 重试 | 指数退避（500ms/1s/2s），失败后数据放回缓冲区 |
| 格式兼容 | 同时支持 V4 新格式和旧版 `deviceId/sensorId` 格式 |
| 健康监控 | throughput/lag/errorRate/bufferUtilization 指标 |

### 3.5 启动编排器（Layer 4 — 编排层）

**启动顺序**（下游先就绪）：
1. ClickHouse Sink → 确保存储层就绪
2. 特征提取服务 → 确保处理层就绪
3. 网关桥接 → 最后开放数据入口

**关闭顺序**（上游先关闭）：
3. 网关桥接 → 停止接收新数据
2. 特征提取 → 处理完剩余消息（等待 1s）
1. ClickHouse Sink → 刷写完剩余缓冲（等待 1s）

**降级策略**：
- ClickHouse 不可用 → 数据仍在 Kafka 中保留（可重放）
- 特征提取不可用 → 原始数据直接写入 ClickHouse（无特征值）
- 网关桥接不可用 → 网关数据可通过其他方式接入（HTTP API 等）

---

## 四、修改的现有文件

| 文件 | 改动 |
|------|------|
| `server/core/index.ts` | +10 行：在 `server.listen` 后启动数据动脉 |
| `server/platform/middleware/gracefulShutdown.ts` | +8 行：注册数据动脉关闭钩子（优先级 50） |

---

## 五、遗留问题与后续计划

| 优先级 | 问题 | 计划 |
|--------|------|------|
| P1 | 视觉提取器依赖外部推理服务（TorchServe/Triton） | 需要部署推理服务并配置连接 |
| P1 | OPC-UA 和 Modbus 协议适配器为预留接口 | 需要集成 node-opcua 和 modbus-serial |
| P2 | DSP 工具库为纯 TypeScript 实现，大数据量时性能有限 | 可替换为 WASM 或 native addon |
| P2 | 网关认证目前为 API Key，生产环境需要证书双向认证 | 集成 mTLS |
| P3 | 特征提取算法参数硬编码 | 需要接入算法配置中心，支持用户自定义 |
| P3 | 缺少端到端延迟监控 | 需要在每层注入 tracing span |
