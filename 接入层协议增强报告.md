# 接入层协议工业级增强报告

**提交**: `43d199e` | **日期**: 2026-02-19 | **变更文件**: 15 | **新增代码**: +2109 行

---

## 一、增强总览

本次增强按照工业环境实际需求，对接入层进行了全面补强，覆盖 **协议适配器配置项**、**新增工业协议**、**前端交互增强**、**后端运维增强** 四大维度。

| 维度 | 增强内容 | 涉及文件数 |
|------|---------|-----------|
| 协议配置增强 | Modbus/OPC-UA/MQTT 配置项补充至工业级 | 3 |
| 新增工业协议 | EtherNet/IP、PROFINET、EtherCAT | 4（含注册中心） |
| 前端交互增强 | group 分组、textarea、演示数据、批量检查、端点 CRUD | 1 |
| 后端运维增强 | 定时健康巡检 Job、batchHealthCheck API | 4 |

---

## 二、协议适配器增强详情

### 2.1 Modbus（modbus.adapter.ts）

| 配置类别 | 增强前 | 增强后 |
|---------|--------|--------|
| 传输模式 | RTU/TCP | RTU/ASCII/TCP/Plus |
| 协议角色 | 仅主站 | 主站(Master)/从站(Slave) |
| 功能码 | 无配置 | 01-06, 15, 16, 43 可选 |
| 数据类型 | 无 | int16/uint16/int32/uint32/float32/float64/string |
| 帧间隔 | 无 | T3.5 字符时间（RTU 必须） |
| 字节序 | 无 | Big-Endian/Little-Endian/Mid-Big/Mid-Little |
| 诊断 | 无 | 诊断功能码 08 支持 |
| 高级分组 | 无 | 传输控制、数据映射、诊断 三个分组 |

### 2.2 OPC UA（opcua.adapter.ts）

| 配置类别 | 增强前 | 增强后 |
|---------|--------|--------|
| Security Policy | Basic256Sha256 | None/Basic128Rsa15/Basic256/Basic256Sha256/Aes128_Sha256_RsaOaep/Aes256_Sha256_RsaPss |
| Security Mode | 无 | None/Sign/SignAndEncrypt |
| 认证方式 | 用户名/密码 | Anonymous/UserName/Certificate/IssuedToken |
| 证书 | 无 | Client Certificate PEM (textarea) / Private Key PEM (textarea) |
| Namespace | 无 | Namespace URI 配置 |
| Session | 无 | Session Timeout / KeepAlive Interval / Publishing Interval / Queue Size |
| 高级分组 | 无 | 安全策略、会话管理、证书配置、信息模型 四个分组 |

### 2.3 MQTT（mqtt.adapter.ts）

| 配置类别 | 增强前 | 增强后 |
|---------|--------|--------|
| Sparkplug B | 无 | Group ID / Edge Node ID / Device ID / Sparkplug 版本 |
| 工业场景 | 无 | 遗嘱消息(LWT) / 自动重连间隔 / 最大重连延迟 |

---

## 三、新增工业协议

### 3.1 EtherNet/IP (CIP)（ethernetip.adapter.ts）

面向 Allen-Bradley PLC、Rockwell 自动化设备。

- **连接参数**: IP 地址、TCP 端口(44818)、Vendor ID、Product Code、Device Type、Serial Number
- **认证**: 无（CIP 协议本身无认证）
- **高级配置**: Assembly 实例(Input/Output/Config)、RPI(ms)、Connection Type(Exclusive/Redundant)、CIP 路由路径、EDS 文件路径、Watchdog、Transport Type(O→T/T→O)
- **资源发现**: 自动扫描 CIP 对象列表
- **分组**: CIP 连接参数、Assembly 实例、传输配置

### 3.2 PROFINET（profinet.adapter.ts）

面向 Siemens S7 PLC、PROFINET IO 设备。

- **连接参数**: 设备 IP、Device Name(DCP)、Station Name、GSDML 文件路径、通信模式(RT/IRT)
- **认证**: 无（PROFINET 无内置认证）
- **高级配置**: Watchdog Factor、Reduction Ratio、Send Clock Factor、IO 数据映射(JSON)、DCP 自动发现、LLDP 拓扑发现、MRP 环网配置
- **资源发现**: DCP 广播扫描 + GSDML 解析
- **分组**: 设备标识、通信参数、IO 数据映射、网络拓扑

### 3.3 EtherCAT（ethercat.adapter.ts）

面向伺服驱动器、高速 I/O 模块。

- **连接参数**: 网卡接口、ESI 文件路径、从站地址、DC 时钟模式(FreeRun/DC/DC-Sync0/DC-Sync01)
- **认证**: 无
- **高级配置**: PDO 映射(JSON)、SDO 配置(JSON)、Cycle Time(μs)、CoE 邮箱支持、FoE 文件传输、EoE 以太网隧道、状态机初始目标(Init/PreOp/SafeOp/Op)、Watchdog Divider/Time
- **资源发现**: ESI 文件解析 + 从站扫描
- **分组**: 从站配置、DC 时钟、PDO/SDO 映射、邮箱协议、状态机

---

## 四、前端增强

### 4.1 DynamicFormField 增强

- **新增 `textarea` 类型**: 用于 PEM 证书、JSON 片段等多行文本，等宽字体渲染
- **新增 `json` 类型优化**: 自动 JSON.parse/stringify，语法高亮提示

### 4.2 高级配置 Group 分组渲染

- `GroupedAdvancedFields` 组件：按 `group` 字段自动分组
- 折叠面板交互：默认收起，点击展开
- 单组时自动平铺（无需折叠）

### 4.3 操作按钮增强

| 按钮 | 功能 |
|------|------|
| 演示数据 | 一键加载示例连接器（调用 `seedDemoData` API） |
| 批量检查 | 全量健康检查 + 结果对话框（healthy/unhealthy/latencyMs） |
| 刷新 | 刷新所有数据 |

### 4.4 EndpointDialog CRUD

- **自动发现**: 调用 `discoverEndpoints` API
- **手动添加**: 表单创建端点（名称/资源路径/资源类型/数据格式）
- **编辑**: 内联编辑端点属性
- **删除**: 确认后删除
- **资源类型**: data/topic/register/node/table/io-data/pdo-entry/sdo/diagnostic/slave/assembly
- **数据格式**: json/binary/csv/protobuf/sparkplug-b

---

## 五、后端运维增强

### 5.1 定时健康巡检 Job（connectorHealthCheck.job.ts）

| 配置项 | 值 |
|--------|-----|
| 巡检间隔 | 60 秒（可配置） |
| 首次延迟 | 10 秒（等待系统启动） |
| 连续失败阈值 | 3 次 |
| 日志策略 | 前 3 次 WARN，第 4 次 ERROR，之后静默 |
| 恢复检测 | 自动检测恢复并重置计数器 |
| 跳过规则 | draft 状态连接器不检查 |

### 5.2 数据动脉集成

- `startDataArtery()` 中作为 Layer 4 自动启动
- `stopDataArtery()` 中优先停止（在上游关闭之前）
- 启动失败时降级运行（不阻塞其他服务）

### 5.3 batchHealthCheck API

- 端点: `trpc.accessLayer.batchHealthCheck.mutate()`
- 返回: `{ total, healthy, unhealthy, results: [{ connectorId, name, status, message, latencyMs }] }`

---

## 六、协议配置完整度对照表

| 协议 | 物理/网络层 | 协议角色 | 设备标识 | 数据映射 | 实时/周期 | 描述文件 | 安全/认证 | 诊断/报警 |
|------|-----------|---------|---------|---------|---------|---------|---------|---------|
| Modbus RTU/ASCII/TCP/Plus | ✅ 串口+TCP | ✅ 主/从 | ✅ Slave ID | ✅ 寄存器+类型 | ✅ T3.5+超时 | — | — | ✅ FC08 |
| OPC UA | ✅ TCP | ✅ Client | ✅ Namespace | ✅ NodeId | ✅ Session+Pub | — | ✅ 6种Policy | ✅ 状态码 |
| MQTT | ✅ TCP+TLS | ✅ Client | ✅ Client ID | ✅ Topic | ✅ KeepAlive | — | ✅ TLS+Auth | ✅ LWT |
| EtherNet/IP | ✅ TCP 44818 | ✅ Scanner | ✅ Vendor+Product | ✅ Assembly | ✅ RPI | ✅ EDS | — | ✅ CIP状态 |
| PROFINET | ✅ Ethernet | ✅ Controller | ✅ DeviceName | ✅ IO映射 | ✅ SendClock | ✅ GSDML | — | ✅ DCP |
| EtherCAT | ✅ Ethernet | ✅ Master | ✅ 从站地址 | ✅ PDO/SDO | ✅ DC时钟 | ✅ ESI | — | ✅ 状态机 |
| HTTP/REST | ✅ TCP | ✅ Client | — | ✅ URL | ✅ 超时 | — | ✅ Bearer | ✅ 状态码 |
| gRPC | ✅ TCP | ✅ Client | — | ✅ Proto | ✅ 超时 | — | ✅ TLS | ✅ 状态码 |
| WebSocket | ✅ TCP | ✅ Client | — | ✅ URL | ✅ Ping | — | ✅ TLS | ✅ 心跳 |
| Kafka | ✅ TCP | ✅ Producer/Consumer | ✅ Group ID | ✅ Topic | ✅ Poll | — | ✅ SASL | ✅ Offset |
| InfluxDB | ✅ TCP | ✅ Client | ✅ Org+Bucket | ✅ Measurement | ✅ 超时 | — | ✅ Token | ✅ 状态码 |
| ClickHouse | ✅ TCP | ✅ Client | ✅ Database | ✅ Table | ✅ 超时 | — | ✅ Auth | ✅ 状态码 |
| PostgreSQL | ✅ TCP | ✅ Client | ✅ Database | ✅ Schema | ✅ Pool | — | ✅ SSL | ✅ 状态码 |
| MinIO/S3 | ✅ TCP | ✅ Client | ✅ Bucket | ✅ Prefix | ✅ 超时 | — | ✅ AK/SK | ✅ 状态码 |
| Qdrant | ✅ TCP | ✅ Client | ✅ Collection | ✅ Vector | ✅ 超时 | — | ✅ API Key | ✅ 状态码 |

---

## 七、验证步骤

```bash
git pull origin main
pnpm dev
```

1. 访问 **接入层管理** 页面 → 协议总览应显示 15 个协议（含新增的 EtherNet/IP、PROFINET、EtherCAT）
2. 点击 **新建连接器** → 选择 Modbus → 应看到角色选择(Master/Slave)、功能码配置等新字段
3. 选择 OPC UA → 展开高级配置 → 应看到按"安全策略/会话管理/证书配置/信息模型"分组的折叠面板
4. 点击 **演示数据** → 应加载示例连接器
5. 点击 **批量检查** → 应弹出检查结果对话框
6. 点击连接器的 **端点** 按钮 → 应看到完整的端点 CRUD 界面
7. 查看启动日志 → 应看到 `[DataArtery] ✓ Layer 4: 连接器健康巡检已启动 (60s 间隔)`
