# Falco 自定义规则配置
# 西联智能平台 - 港口设备智能运维安全规则
# Version: 1.0.0

apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-rules
  namespace: falco-system
  labels:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: rules
data:
  xilian_rules.yaml: |
    # ============================================
    # 西联智能平台自定义 Falco 安全规则
    # ============================================
    
    # 宏定义
    - macro: xilian_containers
      condition: >
        (container.image.repository contains "xilian" or
         container.name contains "xilian" or
         k8s.ns.name = "xilian-platform")
    
    - macro: xilian_sensitive_files
      condition: >
        (fd.name startswith "/etc/xilian/" or
         fd.name startswith "/var/lib/xilian/" or
         fd.name contains ".env" or
         fd.name contains "secrets" or
         fd.name contains "credentials")
    
    - macro: xilian_allowed_processes
      condition: >
        (proc.name in (node, python, python3, java, go, rust, nginx, redis-server, 
                       clickhouse-server, kafka, flink, neo4j, qdrant))
    
    - macro: xilian_network_allowed
      condition: >
        (fd.sip in ("10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16") or
         fd.sport in (80, 443, 3000, 5432, 6379, 8080, 8443, 9000, 9092, 9200))
    
    # 列表定义
    - list: xilian_sensitive_env_vars
      items: [DATABASE_URL, JWT_SECRET, API_KEY, OAUTH_SECRET, REDIS_PASSWORD, 
              KAFKA_PASSWORD, CLICKHOUSE_PASSWORD, NEO4J_PASSWORD, QDRANT_API_KEY,
              VAULT_TOKEN, AWS_SECRET_ACCESS_KEY]
    
    - list: xilian_critical_binaries
      items: [kubectl, docker, crictl, runc, containerd, kubelet]
    
    - list: xilian_mining_processes
      items: [xmrig, minerd, cpuminer, cgminer, bfgminer, ethminer, 
              stratum, cryptonight, monero]
    
    - list: xilian_reverse_shell_binaries
      items: [nc, ncat, netcat, socat, bash, sh, zsh, dash, ksh, csh, fish]
    
    # ============================================
    # P0 - 关键安全规则（立即告警）
    # ============================================
    
    - rule: 敏感配置文件访问
      desc: 检测对西联平台敏感配置文件的访问
      condition: >
        open_read and
        xilian_sensitive_files and
        container and
        not proc.name in (node, python, python3)
      output: >
        敏感文件被访问 (user=%user.name user_uid=%user.uid 
        file=%fd.name container=%container.name 
        image=%container.image.repository:%container.image.tag 
        command=%proc.cmdline)
      priority: WARNING
      tags: [security, file_access, xilian, P0]
    
    - rule: 环境变量泄露尝试
      desc: 检测尝试读取敏感环境变量
      condition: >
        spawned_process and
        container and
        (proc.cmdline contains "env" or proc.cmdline contains "printenv") and
        (proc.cmdline icontains "password" or 
         proc.cmdline icontains "secret" or
         proc.cmdline icontains "key" or
         proc.cmdline icontains "token")
      output: >
        环境变量泄露尝试 (user=%user.name container=%container.name 
        command=%proc.cmdline image=%container.image.repository)
      priority: ERROR
      tags: [security, credentials, xilian, P0]
    
    - rule: 容器逃逸尝试
      desc: 检测容器逃逸攻击尝试
      condition: >
        spawned_process and
        container and
        (proc.cmdline contains "nsenter" or
         proc.cmdline contains "docker.sock" or
         proc.cmdline contains "/proc/1/root" or
         proc.cmdline contains "/.dockerenv" or
         proc.cmdline contains "cgroup" and proc.cmdline contains "release_agent")
      output: >
        容器逃逸尝试 (user=%user.name container=%container.name 
        command=%proc.cmdline image=%container.image.repository 
        namespace=%k8s.ns.name pod=%k8s.pod.name)
      priority: CRITICAL
      tags: [security, container_escape, xilian, P0]
    
    - rule: 特权容器启动
      desc: 检测特权容器的启动
      condition: >
        container_started and
        container.privileged = true and
        not k8s.ns.name in (kube-system, falco-system, istio-system)
      output: >
        特权容器启动 (container=%container.name 
        image=%container.image.repository:%container.image.tag 
        namespace=%k8s.ns.name pod=%k8s.pod.name)
      priority: ERROR
      tags: [security, privileged, xilian, P0]
    
    - rule: 挖矿程序检测
      desc: 检测加密货币挖矿程序
      condition: >
        spawned_process and
        container and
        (proc.name in (xilian_mining_processes) or
         proc.cmdline contains "stratum+tcp" or
         proc.cmdline contains "pool.minexmr" or
         proc.cmdline contains "cryptonight")
      output: >
        挖矿程序检测 (user=%user.name container=%container.name 
        process=%proc.name command=%proc.cmdline 
        image=%container.image.repository)
      priority: CRITICAL
      tags: [security, cryptomining, xilian, P0]
    
    - rule: 反弹Shell检测
      desc: 检测反弹Shell连接尝试
      condition: >
        spawned_process and
        container and
        proc.name in (xilian_reverse_shell_binaries) and
        (proc.cmdline contains "/dev/tcp" or
         proc.cmdline contains "bash -i" or
         proc.cmdline contains "nc -e" or
         proc.cmdline contains "ncat -e" or
         proc.cmdline contains "mkfifo" or
         proc.cmdline contains "telnet" and proc.cmdline contains "sh")
      output: >
        反弹Shell检测 (user=%user.name container=%container.name 
        command=%proc.cmdline image=%container.image.repository 
        namespace=%k8s.ns.name)
      priority: CRITICAL
      tags: [security, reverse_shell, xilian, P0]
    
    # ============================================
    # P1 - 高优先级规则（5分钟内响应）
    # ============================================
    
    - rule: 异常外部网络连接
      desc: 检测到非预期的外部网络连接
      condition: >
        outbound and
        container and
        xilian_containers and
        not xilian_network_allowed and
        not fd.sip in ("0.0.0.0/0")
      output: >
        异常外部连接 (container=%container.name 
        connection=%fd.name server_ip=%fd.sip server_port=%fd.sport 
        process=%proc.name image=%container.image.repository)
      priority: WARNING
      tags: [security, network, xilian, P1]
    
    - rule: 数据库直接访问
      desc: 检测非授权的数据库直接访问
      condition: >
        outbound and
        container and
        fd.sport in (5432, 3306, 6379, 9000, 7474, 6333) and
        not xilian_containers and
        not k8s.ns.name in (xilian-platform, monitoring, backup)
      output: >
        数据库直接访问 (container=%container.name 
        database_port=%fd.sport server_ip=%fd.sip 
        process=%proc.name namespace=%k8s.ns.name)
      priority: WARNING
      tags: [security, database, xilian, P1]
    
    - rule: K8s API 异常访问
      desc: 检测对 Kubernetes API 的异常访问
      condition: >
        outbound and
        container and
        fd.sport = 6443 and
        not k8s.ns.name in (kube-system, istio-system, argocd)
      output: >
        K8s API 异常访问 (container=%container.name 
        namespace=%k8s.ns.name pod=%k8s.pod.name 
        process=%proc.name command=%proc.cmdline)
      priority: WARNING
      tags: [security, k8s_api, xilian, P1]
    
    - rule: 敏感目录写入
      desc: 检测对敏感目录的写入操作
      condition: >
        open_write and
        container and
        (fd.name startswith "/etc/" or
         fd.name startswith "/root/" or
         fd.name startswith "/var/run/" or
         fd.name startswith "/proc/") and
        not proc.name in (systemd, init, kubelet)
      output: >
        敏感目录写入 (user=%user.name file=%fd.name 
        container=%container.name process=%proc.name 
        command=%proc.cmdline)
      priority: WARNING
      tags: [security, file_write, xilian, P1]
    
    - rule: 软件包安装检测
      desc: 检测运行时软件包安装
      condition: >
        spawned_process and
        container and
        (proc.name in (apt, apt-get, yum, dnf, apk, pip, pip3, npm, yarn, pnpm) or
         proc.cmdline contains "install")
      output: >
        运行时软件包安装 (container=%container.name 
        command=%proc.cmdline image=%container.image.repository 
        namespace=%k8s.ns.name)
      priority: NOTICE
      tags: [security, package_install, xilian, P1]
    
    # ============================================
    # P2 - 中优先级规则（1小时内响应）
    # ============================================
    
    - rule: 异常进程启动
      desc: 检测非预期进程的启动
      condition: >
        spawned_process and
        container and
        xilian_containers and
        not xilian_allowed_processes and
        not proc.name startswith "."
      output: >
        异常进程启动 (container=%container.name 
        process=%proc.name command=%proc.cmdline 
        parent=%proc.pname image=%container.image.repository)
      priority: NOTICE
      tags: [security, process, xilian, P2]
    
    - rule: 大文件传输
      desc: 检测大文件传输操作
      condition: >
        open_read and
        container and
        fd.typechar = 'f' and
        evt.rawres >= 104857600
      output: >
        大文件传输 (container=%container.name 
        file=%fd.name size=%evt.rawres 
        process=%proc.name)
      priority: NOTICE
      tags: [security, data_exfil, xilian, P2]
    
    - rule: 调试工具使用
      desc: 检测调试工具的使用
      condition: >
        spawned_process and
        container and
        proc.name in (gdb, strace, ltrace, ptrace, perf, tcpdump, wireshark, tshark)
      output: >
        调试工具使用 (container=%container.name 
        tool=%proc.name command=%proc.cmdline 
        user=%user.name)
      priority: NOTICE
      tags: [security, debug, xilian, P2]
    
    - rule: SSH 连接尝试
      desc: 检测 SSH 连接尝试
      condition: >
        spawned_process and
        container and
        (proc.name = ssh or proc.name = sshd) and
        not k8s.ns.name in (kube-system)
      output: >
        SSH 连接尝试 (container=%container.name 
        command=%proc.cmdline user=%user.name 
        namespace=%k8s.ns.name)
      priority: NOTICE
      tags: [security, ssh, xilian, P2]
    
    # ============================================
    # 港口设备特定规则
    # ============================================
    
    - rule: 设备控制命令异常
      desc: 检测对港口设备的异常控制命令
      condition: >
        spawned_process and
        container and
        xilian_containers and
        (proc.cmdline contains "modbus" or
         proc.cmdline contains "opcua" or
         proc.cmdline contains "plc" or
         proc.cmdline contains "scada")
      output: >
        设备控制命令 (container=%container.name 
        command=%proc.cmdline user=%user.name 
        namespace=%k8s.ns.name pod=%k8s.pod.name)
      priority: WARNING
      tags: [security, iot, industrial, xilian, P1]
    
    - rule: 传感器数据异常访问
      desc: 检测对传感器数据的异常访问模式
      condition: >
        open_read and
        container and
        (fd.name contains "sensor" or 
         fd.name contains "telemetry" or
         fd.name contains "iot") and
        not xilian_containers
      output: >
        传感器数据异常访问 (container=%container.name 
        file=%fd.name process=%proc.name 
        user=%user.name)
      priority: WARNING
      tags: [security, iot, sensor, xilian, P1]
    
    - rule: AI模型文件访问
      desc: 检测对 AI 模型文件的访问
      condition: >
        open_read and
        container and
        (fd.name endswith ".pt" or
         fd.name endswith ".pth" or
         fd.name endswith ".onnx" or
         fd.name endswith ".pb" or
         fd.name endswith ".h5" or
         fd.name contains "model" and fd.name endswith ".bin")
      output: >
        AI模型文件访问 (container=%container.name 
        file=%fd.name process=%proc.name 
        user=%user.name image=%container.image.repository)
      priority: NOTICE
      tags: [security, ai_model, xilian, P2]
