# Falco Runtime Security DaemonSet
# 西联智能平台 - 容器运行时安全监控
# Version: 0.37.0

apiVersion: v1
kind: Namespace
metadata:
  name: falco-system
  labels:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: security

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falco
  namespace: falco-system
  labels:
    app.kubernetes.io/name: falco

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: falco
  labels:
    app.kubernetes.io/name: falco
rules:
  - apiGroups: [""]
    resources: ["nodes", "pods", "namespaces", "services", "endpoints"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "daemonsets", "replicasets", "statefulsets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["networkpolicies"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: falco
  labels:
    app.kubernetes.io/name: falco
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: falco
subjects:
  - kind: ServiceAccount
    name: falco
    namespace: falco-system

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-config
  namespace: falco-system
  labels:
    app.kubernetes.io/name: falco
data:
  falco.yaml: |
    # Falco 主配置文件
    # 西联智能平台定制配置
    
    # 规则文件路径
    rules_file:
      - /etc/falco/falco_rules.yaml
      - /etc/falco/falco_rules.local.yaml
      - /etc/falco/k8s_audit_rules.yaml
      - /etc/falco/xilian_rules.yaml
    
    # 时间格式
    time_format_iso_8601: true
    
    # JSON 输出
    json_output: true
    json_include_output_property: true
    json_include_tags_property: true
    
    # 日志级别
    log_stderr: true
    log_syslog: false
    log_level: info
    
    # 优先级过滤
    priority: debug
    
    # 缓冲输出
    buffered_outputs: false
    
    # 系统调用事件源
    syscall_event_drops:
      threshold: 0.1
      actions:
        - log
        - alert
      rate: 0.03333
      max_burst: 1
    
    # 输出通道配置
    stdout_output:
      enabled: true
    
    file_output:
      enabled: true
      keep_alive: false
      filename: /var/log/falco/events.log
    
    syslog_output:
      enabled: false
    
    # HTTP 输出到 Falco Sidekick
    http_output:
      enabled: true
      url: http://falco-sidekick:2801/
      user_agent: "falco/0.37.0"
    
    # gRPC 服务
    grpc:
      enabled: true
      bind_address: "unix:///var/run/falco/falco.sock"
      threadiness: 8
    
    grpc_output:
      enabled: true
    
    # Kubernetes 审计日志
    webserver:
      enabled: true
      listen_port: 8765
      k8s_healthz_endpoint: /healthz
      ssl_enabled: false
    
    # 元数据下载
    metadata_download:
      max_mb: 100
      chunk_wait_us: 1000
      watch_freq_sec: 1

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
  namespace: falco-system
  labels:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: runtime-security
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: falco
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: falco
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8765"
    spec:
      serviceAccountName: falco
      hostNetwork: true
      hostPID: true
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
        - key: node-role.kubernetes.io/control-plane
          effect: NoSchedule
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      containers:
        - name: falco
          image: falcosecurity/falco:0.37.0
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          args:
            - /usr/bin/falco
            - --cri
            - /run/containerd/containerd.sock
            - -K
            - /var/run/secrets/kubernetes.io/serviceaccount/token
            - -k
            - https://kubernetes.default.svc
            - --k8s-node
            - "$(FALCO_K8S_NODE_NAME)"
            - -pk
          env:
            - name: FALCO_K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: FALCO_BPF_PROBE
              value: ""
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1024Mi
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8765
            initialDelaySeconds: 60
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8765
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: falco-config
              mountPath: /etc/falco
            - name: falco-rules
              mountPath: /etc/falco/xilian_rules.yaml
              subPath: xilian_rules.yaml
            - name: containerd-socket
              mountPath: /run/containerd/containerd.sock
              readOnly: true
            - name: dev
              mountPath: /host/dev
              readOnly: true
            - name: proc
              mountPath: /host/proc
              readOnly: true
            - name: boot
              mountPath: /host/boot
              readOnly: true
            - name: lib-modules
              mountPath: /host/lib/modules
              readOnly: true
            - name: usr
              mountPath: /host/usr
              readOnly: true
            - name: etc
              mountPath: /host/etc
              readOnly: true
            - name: falco-logs
              mountPath: /var/log/falco
            - name: falco-socket
              mountPath: /var/run/falco
      volumes:
        - name: falco-config
          configMap:
            name: falco-config
        - name: falco-rules
          configMap:
            name: falco-rules
        - name: containerd-socket
          hostPath:
            path: /run/containerd/containerd.sock
        - name: dev
          hostPath:
            path: /dev
        - name: proc
          hostPath:
            path: /proc
        - name: boot
          hostPath:
            path: /boot
        - name: lib-modules
          hostPath:
            path: /lib/modules
        - name: usr
          hostPath:
            path: /usr
        - name: etc
          hostPath:
            path: /etc
        - name: falco-logs
          hostPath:
            path: /var/log/falco
            type: DirectoryOrCreate
        - name: falco-socket
          hostPath:
            path: /var/run/falco
            type: DirectoryOrCreate

---
apiVersion: v1
kind: Service
metadata:
  name: falco
  namespace: falco-system
  labels:
    app.kubernetes.io/name: falco
spec:
  type: ClusterIP
  ports:
    - name: grpc
      port: 5060
      targetPort: 5060
      protocol: TCP
    - name: http
      port: 8765
      targetPort: 8765
      protocol: TCP
  selector:
    app.kubernetes.io/name: falco
