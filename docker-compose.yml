# ============================================================
# PortAI Nexus - 全栈一键部署 Docker Compose
# 包含: MySQL + Redis + ClickHouse + MinIO + Qdrant + Kafka + NebulaGraph
# ============================================================
# 启动方式:
#   全部启动:   docker-compose up -d
#   最小启动:   docker-compose up -d mysql redis
#   核心数据库: docker-compose up -d mysql redis clickhouse qdrant
#   停止全部:   docker-compose down
#   查看日志:   docker-compose logs -f <service>
#   查看状态:   docker-compose ps
# ============================================================

services:
  # ==================== Application ====================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: portai-nexus
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - SKIP_AUTH=${SKIP_AUTH:-true}
      - DATABASE_URL=mysql://portai:portai123@mysql:3306/portai_nexus
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BROKERS=kafka:29092
      - KAFKA_CLIENT_ID=xilian-platform
      - OLLAMA_HOST=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.1:70b}
      - QDRANT_HOST=http://qdrant:6333
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DATABASE=portai_timeseries
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-portai}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-portai123456}
      - NEBULA_HOST=nebula-graphd
      - NEBULA_PORT=9669
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - portai-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/rest/_health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== Core: MySQL 8.0 ====================
  # 关系型数据库 — 存储所有核心业务数据
  mysql:
    image: mysql:8.0
    container_name: portai-mysql
    restart: unless-stopped
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123}
      MYSQL_DATABASE: portai_nexus
      MYSQL_USER: portai
      MYSQL_PASSWORD: portai123
      TZ: Asia/Shanghai
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max-connections=500
      --innodb-buffer-pool-size=256M
      --slow-query-log=1
      --long-query-time=2
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    networks:
      - portai-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot123"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ==================== Core: Redis 7 ====================
  # 缓存层 — 设备状态缓存、会话管理、事件去重、分布式锁
  redis:
    image: redis:7-alpine
    container_name: portai-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
    volumes:
      - redis_data:/data
    networks:
      - portai-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==================== TSDB: ClickHouse ====================
  # 时序数据库 — 存储高频传感器数据和聚合指标
  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    container_name: portai-clickhouse
    restart: unless-stopped
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_NATIVE_PORT:-9000}:9000"
    environment:
      CLICKHOUSE_DB: portai_timeseries
      CLICKHOUSE_USER: portai
      CLICKHOUSE_PASSWORD: portai123
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
      - ./docker/clickhouse/init:/docker-entrypoint-initdb.d
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - portai-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ==================== Object Store: MinIO ====================
  # 对象存储 — 波形文件、频谱图、模型文件等大文件
  minio:
    image: minio/minio:latest
    container_name: portai-minio
    restart: unless-stopped
    ports:
      - "${MINIO_API_PORT:-9010}:9000"
      - "${MINIO_CONSOLE_PORT:-9011}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-portai}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-portai123456}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - portai-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # MinIO 初始化：自动创建默认存储桶
  minio-init:
    image: minio/mc:latest
    container_name: portai-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set portai http://minio:9000 portai portai123456;
      mc mb --ignore-existing portai/waveforms;
      mc mb --ignore-existing portai/spectrums;
      mc mb --ignore-existing portai/models;
      mc mb --ignore-existing portai/reports;
      mc mb --ignore-existing portai/backups;
      echo '✅ MinIO buckets created successfully';
      exit 0;
      "
    networks:
      - portai-network

  # ==================== Vector DB: Qdrant ====================
  # 向量数据库 — 相似故障检索和语义搜索 (RAG)
  qdrant:
    image: qdrant/qdrant:v1.9.0
    container_name: portai-qdrant
    restart: unless-stopped
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    networks:
      - portai-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:6333/readyz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ==================== Message Queue: Kafka (KRaft) ====================
  # 消息队列 — 事件总线、数据流处理（KRaft 模式，无需 Zookeeper）
  kafka:
    image: apache/kafka:3.7.0
    container_name: portai-kafka
    restart: unless-stopped
    ports:
      - "${KAFKA_PORT:-9092}:9092"
    environment:
      # KRaft 模式（无需 Zookeeper）
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://:29092,CONTROLLER://:9093,EXTERNAL://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,EXTERNAL://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_MESSAGE_MAX_BYTES: 10485760
      CLUSTER_ID: portai-kafka-cluster-001
    volumes:
      - kafka_data:/tmp/kafka-logs
    networks:
      - portai-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:29092 --list || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ==================== Graph DB: Neo4j ====================
  # 图数据库 — 知识图谱和设备关系拓扑（替代 NebulaGraph，原生支持 ARM64）
  neo4j:
    image: neo4j:5.18-community
    container_name: portai-neo4j
    restart: unless-stopped
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-portai123}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_server_memory_heap_initial__size: 256m
      NEO4J_server_memory_heap_max__size: 512m
      NEO4J_server_memory_pagecache_size: 256m
      TZ: Asia/Shanghai
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - portai-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ==================== LLM Engine: Ollama ====================
  # 大模型推理引擎
  ollama:
    image: ollama/ollama:latest
    container_name: portai-ollama
    profiles: ["llm", "full"]
    restart: unless-stopped
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - portai-network
    # Uncomment for NVIDIA GPU support:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # ==================== Monitoring: Prometheus ====================
  prometheus:
    image: prom/prometheus:v2.50.0
    container_name: portai-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    networks:
      - portai-network

  # ==================== Monitoring: Grafana ====================
  grafana:
    image: grafana/grafana:10.3.0
    container_name: portai-grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - portai-network

# ==================== Networks ====================
networks:
  portai-network:
    driver: bridge
    name: portai-network

# ==================== Volumes ====================
volumes:
  mysql_data:
    name: portai-mysql-data
  redis_data:
    name: portai-redis-data
  clickhouse_data:
    name: portai-clickhouse-data
  clickhouse_logs:
    name: portai-clickhouse-logs
  minio_data:
    name: portai-minio-data
  qdrant_data:
    name: portai-qdrant-data
  kafka_data:
    name: portai-kafka-data
  neo4j_data:
    name: portai-neo4j-data
  neo4j_logs:
    name: portai-neo4j-logs
  ollama_data:
    name: portai-ollama-data
  prometheus_data:
    name: portai-prometheus-data
  grafana_data:
    name: portai-grafana-data
