{{/*
通用微服务 PodDisruptionBudget 模板
*/}}
{{- $services := dict
  "api-gateway" .Values.apiGateway
  "device" .Values.deviceService
  "algorithm" .Values.algorithmService
  "data-pipeline" .Values.dataPipeline
  "knowledge" .Values.knowledgeService
  "monitoring" .Values.monitoringService
  "infra" .Values.infraService
}}

{{- range $name, $svc := $services }}
{{- if and $svc.enabled (and $svc.podDisruptionBudget $svc.podDisruptionBudget.enabled) }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ printf "%s-%s" $.Release.Name $name | trunc 63 }}
  namespace: {{ include "xilian.namespace" $ }}
  labels:
    {{- include "xilian.msLabels" (dict "Release" $.Release "name" $name "appVersion" $.Chart.AppVersion) | nindent 4 }}
spec:
  minAvailable: {{ $svc.podDisruptionBudget.minAvailable | default 1 }}
  selector:
    matchLabels:
      {{- include "xilian.msSelectorLabels" (dict "Release" $.Release "name" $name) | nindent 6 }}
{{- end }}
{{- end }}
