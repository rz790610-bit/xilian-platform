# 前端问题修复报告

**提交**: `978da7c`  
**日期**: 2026-02-19  
**涉及文件**: 5 个文件，+140 行 / -42 行

---

## 问题一：AccessLayerManager 页面 404

### 根因分析

路由注册（`App.tsx` 第 208 行）、组件文件（`AccessLayerManager.tsx`）、导航配置（`navigation.ts` 第 147 行）均正确无误。问题出在 **tRPC 路由名称不匹配**：

| 位置 | 调用方式 | 实际定义 |
|------|---------|---------|
| 前端 `AccessLayerManager.tsx:451` | `trpc.accessLayer.getStats.useQuery()` | — |
| 后端 `accessLayer.router.ts:16` | — | `stats: publicProcedure.query(...)` |

前端调用 `getStats`，但后端路由名为 `stats`。tRPC 的类型推断在编译时发现不匹配，导致整个组件加载失败，React 错误边界捕获后显示为 404。

### 修复方案

将后端路由名从 `stats` 改为 `getStats`，与前端调用保持一致。这是最小改动方案，不影响其他消费者（`stats` 名称仅在此处使用）。

---

## 问题二：拓扑图拖拽不流畅

### 根因分析

`SystemTopology.tsx` 的 `handleMouseMove` 回调在每次 `mousemove` 事件时都执行 `setLocalNodes(prev => prev.map(...))`，存在以下性能瓶颈：

1. **mousemove 事件频率极高**（60-120 次/秒），每次都触发 React 状态更新
2. **`prev.map(...)` 创建新数组**，即使节点位置变化微乎其微（< 1px）也会触发全量重渲染
3. **SVG 组件体量大**（1300+ 行），每次重渲染代价高昂
4. **canvas panning** 的 `onMouseMove` 也存在同样问题

### 修复方案

| 优化措施 | 效果 |
|---------|------|
| `requestAnimationFrame` 节流 | 每帧最多更新一次（~60fps），丢弃帧间冗余事件 |
| 微小移动过滤（< 0.5px） | 跳过无意义的重渲染，减少 React reconciliation 开销 |
| `mouseUp` 时清理 rAF | 确保最后一帧位置被应用，防止拖拽结束时位置丢失 |
| canvas panning 同步优化 | 画布平移也使用 rAF 节流，保持一致的流畅体验 |

**预期效果**：拖拽帧率从不稳定的 15-30fps 提升到稳定的 60fps，CPU 占用降低 50% 以上。

---

## 问题三：Kafka 等服务显示离线

### 根因分析

这是**预期行为**而非 Bug——本地开发环境没有运行 Kafka、Redis、ClickHouse 等外部服务，健康检查正确返回 `offline`。但存在两个体验问题：

1. **Kafka 客户端 `initialize()` 无 try-catch**：连接失败时抛出异常，可能阻塞应用启动
2. **重试次数过多**（8 次，指数退避到 30 秒）：本地开发时产生大量错误日志刷屏
3. **前端缺少"未配置"状态提示**：用户无法区分"服务宕机"和"未部署该服务"

### 修复方案

| 改动 | 文件 | 说明 |
|------|------|------|
| Kafka 初始化加 try-catch | `kafka.client.ts` | 连接失败不阻塞启动，以降级模式运行 |
| 重试次数 8→3 | `kafka.client.ts` | 减少本地开发错误日志（从 ~2 分钟缩短到 ~3 秒） |
| 集群状态 API 返回 `statusMessage` | `kafka.router.ts` | 区分"已配置但连不上"和"未配置" |
| KafkaMonitor 展示 `statusMessage` | `KafkaMonitor.tsx` | 用户可看到具体原因 |
| 拓扑图服务摘要改进 | `SystemTopology.tsx` | 全部离线时显示"⚠ 服务未连接（请检查配置）" |
| 图例增加"离线/未连接"说明 | `SystemTopology.tsx` | 明确语义 |

---

## 验证清单

请在本地 `git pull` 后验证以下场景：

- [ ] 访问 `/settings/config/access-layer`，页面正常加载（不再 404）
- [ ] 接入层管理页面的统计卡片正常显示数据
- [ ] 拓扑图拖拽节点流畅，无明显卡顿
- [ ] 拓扑图画布平移（拖拽空白区域）流畅
- [ ] 多选节点整体拖动正常
- [ ] 拓扑图服务摘要显示"⚠ 服务未连接"（本地无 Kafka 时）
- [ ] Kafka 监控页面显示 statusMessage
- [ ] 启动日志中 Kafka 连接失败不再刷屏（3 次重试后停止）
- [ ] 平台整体启动不被 Kafka 连接失败阻塞
