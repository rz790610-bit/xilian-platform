# 知识图谱编排器 — 总体方案设计

> **定位**：在设计工具中新增"知识图谱编排"，提供可视化拖拽式工具集，用于构建基于场景的诊断决策图谱。
> **核心理念**：知识图谱 = 数据 + 历史 + 机理 → 图谱化框架 → 快速复用 + 全面诊断。

---

## 一、与 Pipeline 编排的关系

Pipeline 编排处理的是**数据流**（数据从哪来、怎么处理、到哪去），知识图谱编排处理的是**知识结构**（设备之间什么关系、故障怎么传播、怎么诊断、怎么决策）。两者共享同一套设计工具框架（可视化画布 + 组件面板 + 配置面板 + 工具栏），但组件类型和运行逻辑完全不同。

| 维度 | Pipeline 编排 | 知识图谱编排 |
|------|-------------|-------------|
| 编排对象 | 数据流（Source → Process → Sink） | 知识结构（实体 → 关系 → 推理链） |
| 节点含义 | 数据处理步骤 | 领域实体（设备、故障、症状、解决方案） |
| 连线含义 | 数据传递方向 | 因果/包含/影响/解决等语义关系 |
| 运行方式 | 按 DAG 顺序执行数据处理 | 图遍历 + 推理引擎执行诊断决策 |
| 产出物 | 处理后的数据 | 诊断结论 + 决策路径 + 置信度 |

---

## 二、编排器组件体系

### 2.1 实体节点（可拖拽到画布）

分为 6 大类，每类包含具体的节点子类型：

**设备层（Equipment）**— 物理设备和组件
| 节点类型 | 说明 | 可配置参数 |
|----------|------|-----------|
| 设备 | 起重机、传送带、船舶等 | 型号、制造商、位置、状态阈值 |
| 组件 | 电机、轴承、齿轮箱等 | 部件号、寿命周期、规格参数 |
| 传感器 | 振动、温度、压力等 | 采样率、量程、报警阈值 |
| 泊位 | 码头泊位 | 长度、深度、最大船型 |

**故障层（Fault）**— 故障模式和症状
| 节点类型 | 说明 | 可配置参数 |
|----------|------|-----------|
| 故障模式 | 轴承磨损、电机过热等 | 故障码、严重等级、症状列表、根因 |
| 症状 | 异常振动、温度升高等 | 特征频率、阈值范围、持续时间 |
| 异常模式 | 频谱异常、趋势偏移等 | 检测算法、置信阈值 |

**诊断层（Diagnosis）**— 诊断逻辑和规则
| 节点类型 | 说明 | 可配置参数 |
|----------|------|-----------|
| 诊断规则 | IF-THEN 规则 | 条件表达式、动作、优先级 |
| 决策节点 | 分支判断 | 判断条件、分支权重 |
| 推理引擎 | GNN/LLM 推理 | 模型类型、推理深度（跳数）、置信阈值 |
| 特征提取 | 从原始数据提取特征 | FFT/包络/统计特征、窗口大小 |

**解决方案层（Solution）**— 维修和处置
| 节点类型 | 说明 | 可配置参数 |
|----------|------|-----------|
| 维修方案 | 具体维修步骤 | 步骤列表、所需备件、预估时间、成功率 |
| 应急措施 | 紧急处置 | 动作类型（停机/减速/报警）、执行条件 |
| 预防策略 | 预防性维护计划 | 周期、检查项、触发条件 |

**数据层（Data）**— 数据源和历史
| 节点类型 | 说明 | 可配置参数 |
|----------|------|-----------|
| 历史数据 | 历史故障记录 | 时间范围、数据源、聚合方式 |
| 实时数据 | IoT 传感器流 | MQTT Topic、采样频率、缓冲窗口 |
| 知识库 | 文档/手册/标准 | 关联的 KB 集合、向量检索参数 |

**机理层（Mechanism）**— 物理/工程机理
| 节点类型 | 说明 | 可配置参数 |
|----------|------|-----------|
| 物理模型 | 振动力学、热力学等 | 公式、参数、适用条件 |
| 退化模型 | 寿命预测、磨损曲线 | 退化函数、初始值、加速因子 |
| 阈值模型 | 多级报警阈值 | 正常/注意/警告/危险阈值 |

### 2.2 关系连线（语义边）

拖拽连线时选择关系类型：

| 关系类型 | 语义 | 示例 |
|----------|------|------|
| HAS_PART | 包含/组成 | 起重机 → 电机 |
| HAS_SENSOR | 安装传感器 | 电机 → 振动传感器 |
| CAUSES | 因果关系 | 轴承磨损 → 异常振动 |
| MANIFESTS | 表现为 | 故障模式 → 症状 |
| DIAGNOSED_BY | 诊断依据 | 症状 → 诊断规则 |
| RESOLVED_BY | 解决方案 | 故障模式 → 维修方案 |
| AFFECTS | 影响 | 故障 → 设备/产能 |
| SIMILAR_TO | 相似关系 | 故障A ↔ 故障B |
| DEGRADES_TO | 退化演变 | 轻微磨损 → 严重磨损 |
| TRIGGERS | 触发 | 异常模式 → 应急措施 |
| FEEDS | 数据供给 | 传感器 → 特征提取 |
| REFERENCES | 引用知识 | 诊断规则 → 知识库 |

---

## 三、场景模板

预置 5 个工业诊断场景模板，用户选择后自动生成完整的图谱结构：

### 模板 1：起重机振动诊断图谱
- **场景**：港口起重机振动异常的全链路诊断
- **节点**：起重机 → 电机/齿轮箱/轴承（HAS_PART）→ 振动传感器（HAS_SENSOR）→ FFT特征提取（FEEDS）→ 轴承磨损/齿轮缺陷/不平衡（CAUSES）→ 诊断规则（DIAGNOSED_BY）→ 更换轴承/动平衡/润滑（RESOLVED_BY）
- **推理链**：传感器数据 → 特征提取 → 异常检测 → 故障定位 → 方案推荐

### 模板 2：设备退化预测图谱
- **场景**：基于历史+机理的设备寿命预测
- **节点**：设备 → 关键组件 → 退化模型（物理机理）→ 历史故障数据 → 寿命预测推理引擎 → 预防策略
- **推理链**：实时状态 + 历史趋势 + 退化模型 → 剩余寿命预测 → 维护计划

### 模板 3：故障传播分析图谱
- **场景**：单点故障的级联影响分析
- **节点**：故障源 → 直接影响设备（AFFECTS）→ 间接影响设备 → 产能影响 → 应急措施
- **推理链**：故障点 → 多跳传播路径 → 影响范围评估 → 应急决策

### 模板 4：多模态融合诊断图谱
- **场景**：振动+温度+电流多源数据融合诊断
- **节点**：多个传感器 → 各自特征提取 → 融合决策节点 → 综合诊断 → 方案
- **推理链**：多源特征 → 加权融合 → 综合判断 → 置信度排序

### 模板 5：Fleet 学习图谱
- **场景**：同类设备群体知识共享和迭代
- **节点**：设备群（多台同型号）→ 各自诊断子图 → 共享知识库 → 模式聚合 → 图谱更新
- **推理链**：单机诊断 → 群体统计 → 新模式发现 → 图谱自动补充

---

## 四、自进化机制

图谱不是静态的，具备三个自进化能力：

### 4.1 自升级 — 诊断准确率驱动
- 每次诊断执行后记录结果（正确/误判/漏判）
- 统计每条推理路径的准确率
- 低于阈值的路径自动标记为"待优化"，高准确率路径权重自动提升
- 前端显示每条边的"健康度"（绿/黄/红）

### 4.2 自补充 — 新模式自动发现
- 当出现图谱中未覆盖的故障模式时，系统自动：
  1. 从历史数据中提取新的三元组（LLM 辅助）
  2. 生成候选节点和关系
  3. 标记为"待确认"状态，推送给工程师审核
  4. 确认后正式纳入图谱
- 前端在画布上用虚线/半透明显示"待确认"节点

### 4.3 数据维度迭代 — Fleet 学习
- 同类设备的诊断经验自动汇聚
- 新设备接入时，自动继承同型号设备的图谱模板
- 跨设备的共性故障模式自动合并
- 前端显示"来源设备数"和"置信度"

---

## 五、技术实现方案

### 5.1 前端（设计工具 → 知识图谱编排）

**新增文件**：
```
client/src/pages/settings/design/KGOrchestrator.tsx     # 主页面（类似PipelineEditor）
client/src/components/kg/KGCanvas.tsx                    # 图谱画布（节点+关系可视化）
client/src/components/kg/KGComponentPanel.tsx            # 实体组件面板（6大类拖拽）
client/src/components/kg/KGConfigPanel.tsx               # 节点/关系配置面板
client/src/components/kg/KGToolbar.tsx                   # 工具栏（保存/运行诊断/模板/导入导出）
client/src/stores/kgOrchestratorStore.ts                 # 状态管理
```

**Tab 结构**（与 Pipeline 编排对齐）：
1. **图谱画布** — 拖拽编排主界面
2. **场景模板** — 5 个预置模板 + 自定义模板
3. **诊断运行** — 执行诊断、查看推理路径、结果追溯
4. **自进化面板** — 准确率统计、待确认节点、Fleet 学习状态
5. **图谱列表** — 已保存的所有图谱

### 5.2 后端

**新增文件**：
```
server/platform/services/kg-orchestrator.service.ts      # 图谱编排引擎
server/platform/services/kg-diagnosis.service.ts         # 诊断执行引擎（图遍历+推理）
server/platform/services/kg-evolution.service.ts         # 自进化服务
server/api/kg-orchestrator.router.ts                     # tRPC 路由
```

**复用现有能力**：
- Neo4j 存储层：设备/故障/解决方案节点、因果关系、故障传播路径、社区检测、PageRank、嵌入相似度
- MySQL kgNodes/kgEdges 表：图谱元数据持久化
- 知识库服务：文档解析、向量检索（RAG 辅助诊断）
- 诊断规则表（diagnosisRules）：规则引擎
- 设备/传感器表：设备拓扑数据

### 5.3 数据库扩展

在现有 schema 基础上新增：

```
kg_graphs          # 图谱定义（名称、场景、模板来源、版本）
kg_graph_nodes     # 图谱中的节点实例（类型、配置、画布坐标）
kg_graph_edges     # 图谱中的关系实例（类型、权重、置信度）
kg_diagnosis_runs  # 诊断运行记录
kg_diagnosis_paths # 诊断推理路径
kg_evolution_log   # 自进化日志（自升级/自补充/Fleet学习）
```

### 5.4 导航集成

在"设计工具"菜单下新增：
```
设计工具
├── Pipeline 编排
├── 知识图谱编排    ← 新增
└── 数据库工作台
```

---

## 六、开发顺序

1. **Schema**：新增 6 张表
2. **共享类型**：KG 编排器的节点类型、关系类型、模板类型定义
3. **后端服务**：图谱编排引擎 + 诊断执行引擎 + 自进化服务
4. **后端路由**：tRPC 路由（CRUD + 诊断运行 + 自进化）
5. **前端 Store**：kgOrchestratorStore
6. **前端组件**：KGCanvas + KGComponentPanel + KGConfigPanel + KGToolbar
7. **前端主页面**：KGOrchestrator（5 个 Tab）
8. **场景模板**：5 个预置模板数据
9. **导航/路由集成**

---

## 七、与现有知识图谱页面的关系

| 页面 | 路径 | 定位 |
|------|------|------|
| 知识图谱（知识管理） | /knowledge/graph | 查看和管理已有图谱数据（节点/边的CRUD） |
| 知识图谱（业务应用） | /business/knowledge-graph | 业务层面的图谱应用和查询 |
| **知识图谱编排（设计工具）** | /settings/design/kg-orchestrator | **新增**：设计和构建诊断图谱框架 |

设计工具中构建的图谱，保存后自动同步到知识管理和业务应用中使用。
