# ============================================================
# 西联平台 Prometheus 告警规则
# ============================================================
groups:
  # ── SLO Burn Rate 告警（审核意见6 优化3: 预测 Burn Rate）──
  - name: slo.burn_rate
    interval: 30s
    rules:
      # 快速燃烧 — 1h 窗口 Burn Rate > 14.4（2% 错误预算 / 1h）
      - alert: SLOBurnRateCritical
        expr: |
          (
            sum(rate(http_requests_total{status_code=~"5.."}[1h])) by (service)
            / sum(rate(http_requests_total[1h])) by (service)
          ) / (1 - 0.999) > 14.4
          and
          (
            sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (service)
            / sum(rate(http_requests_total[5m])) by (service)
          ) / (1 - 0.999) > 14.4
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "{{ $labels.service }} SLO 快速燃烧"
          description: "{{ $labels.service }} 1h Burn Rate = {{ $value | printf \"%.1f\" }}x，预计 {{ printf \"%.0f\" (100 / $value * 30 * 24) }}h 耗尽月度错误预算"
          runbook: "https://wiki.xilian.io/runbooks/slo-burn-rate"

      # 慢速燃烧 — 6h 窗口 Burn Rate > 6（5% 错误预算 / 6h）
      - alert: SLOBurnRateWarning
        expr: |
          (
            sum(rate(http_requests_total{status_code=~"5.."}[6h])) by (service)
            / sum(rate(http_requests_total[6h])) by (service)
          ) / (1 - 0.999) > 6
          and
          (
            sum(rate(http_requests_total{status_code=~"5.."}[30m])) by (service)
            / sum(rate(http_requests_total[30m])) by (service)
          ) / (1 - 0.999) > 6
        for: 15m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "{{ $labels.service }} SLO 慢速燃烧"
          description: "{{ $labels.service }} 6h Burn Rate = {{ $value | printf \"%.1f\" }}x"

  # ── 服务健康告警 ──
  - name: service.health
    rules:
      - alert: ServiceDown
        expr: up{job=~"xilian-.*"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.job }} 服务不可达"

      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (service)
          / sum(rate(http_requests_total[5m])) by (service) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.service }} 错误率 > 5%"
          description: "当前错误率: {{ $value | printf \"%.2f\" }}%"

      - alert: HighLatencyP99
        expr: |
          histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.service }} P99 延迟 > 1s"

      - alert: HighLatencyP99Critical
        expr: |
          histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)) > 3
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.service }} P99 延迟 > 3s"

  # ── 断路器告警 ──
  - name: circuit_breaker
    rules:
      - alert: CircuitBreakerOpen
        expr: circuit_breaker_state == 2
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.service }} → {{ $labels.target }} 断路器已打开"
          description: "外部服务 {{ $labels.target }} 不可用，请求被拒绝"

      - alert: CircuitBreakerHalfOpen
        expr: circuit_breaker_state == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.service }} → {{ $labels.target }} 断路器半开状态持续 5 分钟"

  # ── 基础设施告警 ──
  - name: infrastructure
    rules:
      - alert: HighCPUUsage
        expr: |
          sum(rate(container_cpu_usage_seconds_total{namespace=~"xilian.*", container!=""}[5m])) by (pod)
          / sum(kube_pod_container_resource_limits{namespace=~"xilian.*", resource="cpu"}) by (pod) > 0.9
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.pod }} CPU 使用率 > 90%"

      - alert: HighMemoryUsage
        expr: |
          sum(container_memory_working_set_bytes{namespace=~"xilian.*", container!=""}) by (pod)
          / sum(kube_pod_container_resource_limits{namespace=~"xilian.*", resource="memory"}) by (pod) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.pod }} 内存使用率 > 90%"

      - alert: PodRestartLoop
        expr: increase(kube_pod_container_status_restarts_total{namespace=~"xilian.*"}[1h]) > 5
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.pod }} 1 小时内重启 > 5 次"

      - alert: PVCNearFull
        expr: |
          kubelet_volume_stats_used_bytes{namespace=~"xilian.*"}
          / kubelet_volume_stats_capacity_bytes{namespace=~"xilian.*"} > 0.85
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.persistentvolumeclaim }} 存储使用率 > 85%"

  # ── Kafka 告警 ──
  - name: kafka
    rules:
      - alert: KafkaConsumerLagHigh
        expr: kafka_consumer_lag > 10000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.service }} Kafka 消费延迟 > 10000"
          description: "Topic: {{ $labels.topic }}, Partition: {{ $labels.partition }}, Lag: {{ $value }}"

      - alert: KafkaConsumerLagCritical
        expr: kafka_consumer_lag > 100000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.service }} Kafka 消费延迟 > 100000"

  # ── 数据库告警 ──
  - name: database
    rules:
      - alert: DBConnectionPoolExhausted
        expr: db_pool_active_connections / db_pool_max_connections > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.service }} 数据库连接池使用率 > 90%"

      - alert: DBSlowQueries
        expr: rate(db_query_duration_seconds_sum[5m]) / rate(db_query_duration_seconds_count[5m]) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.service }} 数据库平均查询时间 > 1s"
