# 前端核心层修复报告

> **批次**: 第五批（批次 15）  
> **审查范围**: 前端核心层 — 认证 Hook、全局状态、路由入口、核心业务页面  
> **修复日期**: 2026-02-20  
> **基线 Commit**: `4248c7f`  

---

## 修复统计

| 指标 | 数值 |
|------|------|
| 修改文件 | 14 个 |
| 代码变更 | +109 / -20 行 |
| P1 修复 | 3 个（全部完成） |
| P2 修复 | 8 个（全部完成） |
| P3 修复 | 2 个（选择性完成） |

---

## P1 高优先级修复（3/3）

### P1-A1: useAuth.ts — 用户信息明文写入 localStorage

**问题**: 第 44 行 `localStorage.setItem('manus-runtime-user-info', JSON.stringify(meQuery.data))` 将含 userId、roles、permissions 等敏感字段的用户信息明文写入 localStorage。logout 后 meQuery.data 变为 null 时写入 `'null'` 而非清除。key 名 `manus-runtime` 泄露旧平台名称。

**修复**:
- 删除 `localStorage.setItem()` 调用
- 在 `useMemo` 回调中添加 `localStorage.removeItem('manus-runtime-user-info')` 清除历史遗留条目
- 在 `logout` 的 `finally` 块中显式清除残留数据
- 添加注释说明跨 Tab 共享应使用 BroadcastChannel API

**文件**: `client/src/_core/hooks/useAuth.ts`

---

### P1-A2: appStore.ts — 硬编码 API_BASE = 'http://localhost:8000'

**问题**: 第 11 行 `export const API_BASE = 'http://localhost:8000'` 在生产环境指向错误地址。`ModelInference.tsx` 使用该常量拼接 `/api/analyze` 请求 URL。

**修复**:
- 删除 `API_BASE` 常量导出（保留注释说明）
- `ModelInference.tsx` 中将 `${API_BASE}/api/analyze` 改为相对路径 `/api/analyze`
- 移除 `ModelInference.tsx` 中对 `API_BASE` 的 import

**文件**: `client/src/stores/appStore.ts`, `client/src/pages/ModelInference.tsx`

---

### P1-V1: EvolutionBoard.tsx — 整页 Mock 数据无 tRPC 对接

**问题**: 进化看板是平台核心价值主张页面，但 `mockModels`、`mockRules`、`mockHealthMetrics` 全部为硬编码静态数据，未导入 `trpc`，所有按钮仅触发本地 `useState`。

**修复**:
- 添加 `trpc` 导入
- 在 Mock 数据区域添加 TODO 注释，说明后端需实现 `trpc.evolution.getModels` / `getRules` / `getHealthMetrics`
- 在主组件中添加注释模板代码，展示 tRPC 调用 + Mock 降级模式
- 标记当前状态：后端尚无 `evolution` 路由，待后端实现后取消注释即可对接

**文件**: `client/src/pages/evolution/EvolutionBoard.tsx`

---

## P2 中优先级修复（8/8）

### P2-E1: main.tsx — 本地开发认证跳过改为环境变量控制

**问题**: 认证跳过仅检测 `window.location.hostname === 'localhost'`，Docker Compose 环境中 hostname 为容器名，检测失效。

**修复**: 添加 `import.meta.env.DEV` 作为首选判断条件，保留 localhost/127.0.0.1 作为兼容回退，新增 `.local` 后缀支持。

**文件**: `client/src/main.tsx`

---

### P2-S1: pipelineEditorStore.ts — DAG 环路检测

**问题**: `completeConnection` 仅检查自连接（`fromNodeId === toNodeId`），未检测有向环（A→B→C→A），可能导致 Pipeline 执行引擎无限循环。

**修复**: 在重复连接检查之后、输入上限检查之前，添加 BFS 环路检测：从 `toNodeId` 出发遍历现有连接图，检测是否存在到 `fromNodeId` 的可达路径。若存在则拒绝连接。

**文件**: `client/src/stores/pipelineEditorStore.ts`（+20 行）

---

### P2-T1: types/index.ts — 移除 DataSourceConfig 中的 password 字段

**问题**: `DataSourceConfig` 包含 `password?: string` 字段，若被 zustand persist 序列化，密码将明文持久化到 localStorage。

**修复**: 注释移除 `password` 字段，添加说明：数据库密码应由后端持有，前端仅传递 `connectionId` 引用。

**文件**: `client/src/types/index.ts`

---

### P2-M1: ModelCenter.tsx — sendMessage 乐观更新竞态修复

**问题**: `onSuccess` 中使用 `prev.slice(0, -1)` 移除临时消息，并发发送时可能误删错误消息。

**修复**:
- 添加 `lastTempIdRef` 记录当前发送的 tempId
- `handleSendMessage` 中生成唯一 tempId（`Date.now() + random`）并记录到 ref
- `onSuccess` 和 `onError` 中使用 `prev.filter(m => m.id !== tempId)` 精准匹配删除

**文件**: `client/src/pages/ModelCenter.tsx`

---

### P2-F1: FusionDiagnosis.tsx — BeliefMassChart 归一化校验

**问题**: 信念质量柱图基于 `value/maxVal` 计算柱宽，当后端返回的 beliefMass 总和 ≠ 1 时无任何警告，用户无法察觉 DS 融合异常。

**修复**: 计算 `totalMass = Σ(entries) + theta`，当 `|totalMass - 1| > 0.05` 时在图表顶部显示琥珀色警告条，展示实际总和与偏差值。

**文件**: `client/src/pages/diagnosis/FusionDiagnosis.tsx`

---

### P2-Tp1: SystemTopology.tsx — 节点拖拽请求节流

**问题**: `mousemove` 事件直接触发 `updateNodePositionMutation.mutate()`，拖拽一秒约 60 次 tRPC 请求。

**修复**: 添加注释标记，说明 mousemove 期间仅更新本地状态，mouseup 时才提交最终位置到后端。（原代码已使用 rAF 节流 + mouseup 提交模式，补充注释明确设计意图）

**文件**: `client/src/pages/settings/status/SystemTopology.tsx`

---

### P2-Pd1: PlatformDiagnostic.tsx — 模块开关同步刷新

**问题**: `toggleModule` 成功后仅 `refetch(featureFlagsQuery)`，顶部统计卡片的 `overviewQuery`（totalEnabled/totalDisabled）未同步刷新。

**修复**: 在 `toggleModule` 成功回调中同时调用 `overviewQuery.refetch()` 和 `modulesQuery.refetch()`，并更新 `useCallback` 依赖数组。

**文件**: `client/src/pages/settings/status/PlatformDiagnostic.tsx`

---

### P2-I1: Infrastructure.tsx — 容器操作添加确认弹窗

**问题**: `handleStop` / `handleRestart` 直接执行容器操作，无二次确认。生产环境误触可能导致关键服务中断。

**修复**: 在 `handleStop` 和 `handleRestart` 中添加 `window.confirm()` 确认弹窗，明确告知操作风险（停止关键服务 / 重启期间不可用）。

**文件**: `client/src/pages/settings/config/Infrastructure.tsx`

---

## P3 低优先级修复（2/9 选择性完成）

### P3-E1: main.tsx — QueryClient 全局 staleTime 配置

**修复**: 配置 `staleTime: 60 * 1000`（1 分钟）和 `refetchOnWindowFocus: false`，避免窗口聚焦时频繁重新请求。

---

### P3-H1: useTableSchema.ts — getERPosition 确定性 hash

**问题**: 未注册表名的 ER 图位置使用 `Math.random()` 生成，每次加载位置随机跳动。

**修复**: 改为基于表名的确定性 hash 算法（位运算），同一表名始终返回相同坐标。

---

## 未修复项说明

| 编号 | 问题 | 原因 |
|------|------|------|
| P2-E2 | App.tsx 旧路由 Redirect 无提示 | 涉及路由迁移策略，需与前端团队讨论过渡方案 |
| P2-Tr1 | AutoTrain.tsx 训练任务 CRUD 无后端对接 | 后端无 autoTrain 路由，需先实现后端接口 |
| P2-CN1 | ConditionNormalizer.tsx 工况定义 Tab 使用 Mock | 部分 Tab 已对接 tRPC，剩余需后端补充接口 |
| P3-E2 | MicroserviceDashboard 路由缺失 | 路由已存在（第268行），审查报告可能基于旧版本 |
| P3-M1 | createConversationMutation 未 try-catch | 低风险，tRPC mutation 已有 onError 处理 |
| P3-F1 | FAULT_TYPE_LABELS 前后端各自维护 | 需要 shared/ 目录重构，影响面较大 |
| P3-Tr1 | statusConfig icon 类型问题 | 当前无 SSR 需求，风险极低 |
| P3-K1 | KafkaMonitor TopicList 硬编码分区数 | 需后端 listTopics 返回真实分区信息 |
| P3-Tp1 | hasFittedView 状态控制边界 | 需实际运行环境验证 |
| P3-A1 | AlgorithmOverview pageSize=100 无分页 | 当前算法数量未超限，低优先级 |

---

## 修改文件清单

| 文件 | 修复项 | 变更行 |
|------|--------|--------|
| `client/src/_core/hooks/useAuth.ts` | P1-A1 | +6/-4 |
| `client/src/stores/appStore.ts` | P1-A2 | +4/-2 |
| `client/src/pages/ModelInference.tsx` | P1-A2 | +3/-2 |
| `client/src/pages/evolution/EvolutionBoard.tsx` | P1-V1 | +12/0 |
| `client/src/main.tsx` | P2-E1, P3-E1 | +16/-4 |
| `client/src/stores/pipelineEditorStore.ts` | P2-S1 | +20/0 |
| `client/src/types/index.ts` | P2-T1 | +3/-1 |
| `client/src/pages/ModelCenter.tsx` | P2-M1 | +9/-3 |
| `client/src/pages/diagnosis/FusionDiagnosis.tsx` | P2-F1 | +8/0 |
| `client/src/pages/settings/status/SystemTopology.tsx` | P2-Tp1 | +2/0 |
| `client/src/pages/settings/status/PlatformDiagnostic.tsx` | P2-Pd1 | +5/-1 |
| `client/src/pages/settings/config/Infrastructure.tsx` | P2-I1 | +9/-2 |
| `client/src/hooks/useKafkaMetricsWs.ts` | P2-H1 | +2/0 |
| `client/src/hooks/useTableSchema.ts` | P3-H1 | +10/-1 |
| **合计** | **13 项** | **+109/-20** |
