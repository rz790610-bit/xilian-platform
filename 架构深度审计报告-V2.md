# 西联工业智能平台 — 架构深度审计报告 V2

> **审计范围**：20 个架构维度，覆盖数据层、服务层、认知层、插件层、治理层  
> **审计方法**：全量代码静态分析 + 架构模式匹配  
> **代码规模**：~42,000 行服务端代码，129 张数据库表，31 个认知引擎文件，29 个 tRPC 路由  
> **审计日期**：2026-02-19  
> **作者**：Manus AI

---

## 一、执行摘要

本次审计在首轮 8 域审计基础上，新增 12 个架构维度的深度扫描。审计发现平台在认知引擎（31 个文件）、插件沙箱（三层隔离）、Kafka 事件体系（50+ topic）等方面具备扎实的工程基础，但在**系统性治理**层面存在显著缺口：无联邦查询引擎、无中央 Event Schema Registry、无 DDD 边界划分、认知闭环缺少数据回灌和自我优化飞轮。

### 风险矩阵总览

| 等级 | 数量 | 核心特征 |
|:---:|:---:|:---|
| **P0** | 2 项 | 架构级系统性风险，影响全平台可演进性 |
| **P1** | 5 项 | 数据一致性/安全/性能瓶颈 |
| **P2** | 8 项 | 功能缺失/治理不足 |
| **P3** | 5 项 | 优化建议/技术债 |

---

## 二、P0 — 架构级系统性风险

### 2.1 无联邦查询引擎，跨库聚合全靠应用层拼装

**现状**：平台同时使用 MySQL（Drizzle ORM）、ClickHouse、Redis、QuestDB、Elasticsearch 五种数据源。10 个服务存在跨库聚合，其中 `pipeline.engine.ts` 同时查询 PG(11次)、CH(6次)、QD(5次)、Redis(14次)，是最严重的"聚合热点"。

| 服务文件 | MySQL/PG | ClickHouse | QuestDB | Redis | ES | 数据源数 |
|:---|:---:|:---:|:---:|:---:|:---:|:---:|
| pipeline.engine.ts | 11 | 6 | 5 | 14 | 0 | **3** |
| grokPlatformAgent.service.ts | 2 | 5 | 0 | 5 | 2 | **3** |
| access-layer.service.ts | 21 | 2 | 0 | 0 | 0 | 2 |
| topology.service.ts | 20 | 0 | 2 | 0 | 0 | 2 |
| storageHealth.service.ts | 2 | 1 | 1 | 1 | 0 | **3** |

**风险**：每个跨库查询都是手动 `Promise.all` 拼装，无统一错误处理、无查询计划优化、无结果缓存策略。当任一数据源延迟升高时，整个 API 响应时间由最慢数据源决定（木桶效应）。

**建议**：引入轻量级联邦查询层（如 `DataFederator` 服务），统一管理跨库查询的超时、降级、缓存和结果合并。不建议引入重量级联邦引擎（如 Trino/Presto），因为当前场景是 OLTP+OLAP 混合而非纯分析。

### 2.2 无 DDD 边界划分，服务边界模糊导致 God Service

**现状**：`server/` 下有 `platform/`、`services/`、`business/`、`api/` 四个顶层目录，但无 bounded context 划分文档，无聚合根建模。服务间依赖靠 registry 间接耦合，但无强制约束。

**God Service 风险排名**：

| 服务文件 | 行数 | 跨域职责 |
|:---|:---:|:---|
| algorithm.service.ts | 1,865 | 算法元数据 + 推荐 + 编排 + 执行 |
| pipeline.engine.ts | 1,712 | 数据流 + 认知触发 + 3种数据源 |
| access-layer.service.ts | 1,151 | 协议适配 + 设备注册 + 数据路由 |
| database/workbench.service.ts | 1,140 | SQL 执行 + Schema 管理 + 导出 |
| plugin.sandbox.ts | 1,057 | 沙箱隔离 + 权限审计 + 资源计量 |

**风险**：`pipeline.engine.ts` 同时负责数据流编排和认知触发，与 `kg-orchestrator.service.ts` 在"数据流+认知"职责上重叠。随着功能增长，这些 God Service 将成为修改冲突的热点。

**建议**：

1. 制定 Bounded Context Map，至少划分 6 个上下文：**资产域**（设备/传感器/拓扑）、**数据域**（采集/清洗/存储）、**算法域**（定义/编排/执行）、**认知域**（推演/融合/决策）、**运维域**（告警/维保/工单）、**平台域**（插件/配置/权限）。
2. 将 `pipeline.engine.ts` 拆分为 `DataPipelineOrchestrator`（纯数据流）和 `CognitionTrigger`（认知触发入口）。
3. 将 `algorithm.service.ts` 拆分为 `AlgorithmCatalog`（元数据）和 `AlgorithmExecutor`（运行时）。

---

## 三、P1 — 数据一致性/安全/性能

### 3.1 Schema 漂移已发生两次，迁移治理缺失

**证据**：

- `003-fix-schema-consistency.sql`（2026-02-08）：修复 Drizzle↔SQL 列名不一致（`device_id→node_id`、`notes→resolution`）
- `004-full-schema-alignment.sql`（2026-02-08）：全量 camelCase→snake_case 迁移，涉及所有表
- Drizzle 初始迁移 `0000_strong_gravity.sql` 使用 camelCase，与后续 snake_case 规范冲突

**根因**：Drizzle 的 `drizzle-kit generate` 产出的迁移文件命名无业务语义（`0000_strong_gravity.sql`），且 Drizzle schema 与实际 SQL 之间缺少自动校验。`schema.ts`（3,110 行）和 `relations.ts`（486 行）完全手动维护，129 张表的关系定义容易遗漏。

**建议**：

1. 在 CI 中增加 `drizzle-kit check` 步骤，自动检测 schema 漂移
2. 迁移文件命名规范化：`NNNN-<业务描述>.sql`
3. 引入 schema 版本号，与 `relations.ts` 联动校验

### 3.2 ClickHouse 1h 物化视图 std_dev 精度丢失

**证据**：`vibration_features_1hour_agg` 物化视图定义中仅包含 `avgState(rms)`、`maxState(peak)`、`minState(rms)`、`avgState(kurtosis)`、`avgState(temperature)`、`countState()`，**缺少 `stddevState(rms)`**。

而应用层 `clickhouse.client.ts` 在查询 1h 聚合数据时期望返回 `std_dev` 字段（第 102 行、第 381 行），导致该字段始终为 0 或 null。

**影响**：振动分析的趋势离散度指标完全失效，影响异常检测的灵敏度。

**修复**：在物化视图中添加 `stddevState(rms) AS stddev_rms`，并重建历史数据。

### 3.3 插件沙箱 vm.createContext 存在已知逃逸风险

**现状**：插件沙箱采用三层隔离（L1 Worker Threads + L2 vm.createContext + L3 权限网关），已禁用 `eval`/`Function`/`WebAssembly`。但 Node.js 的 `vm.createContext` 有已知的原型链逃逸漏洞（CVE-2023-30581 等），恶意插件可通过 `this.constructor.constructor('return process')()` 逃逸。

**建议**：

1. 短期：在 L2 层增加原型链冻结（`Object.freeze(Object.prototype)`）
2. 中期：迁移到 `isolated-vm`（V8 Isolate 级隔离，无原型链共享）
3. 长期：评估 WebAssembly 沙箱（如 `wasm-sandbox`）或 gVisor

### 3.4 Gateway Bridge 数据校验不足

**现状**：`validateMessage()` 仅检查 `device_code`/`mp_code` 的存在性和格式（正则防注入），但**不检查**：

- `value` 的数值范围（如温度 -50~500°C）
- `timestamp` 的合理性（如未来时间、过期数据）
- `waveform` 数组的长度和数值范围
- 设备是否已注册（`device_code` 是否存在于资产表）

**影响**：脏数据直接进入 Kafka→ClickHouse，污染物化视图和异常检测模型。

**建议**：在 `validateMessage()` 中增加三层校验：

1. **格式校验**（已有）：字段存在性、类型、正则
2. **语义校验**（缺失）：数值范围、时间戳合理性、设备注册校验
3. **统计校验**（缺失）：与最近 N 条数据的偏差检测（可选，高性能场景跳过）

### 3.5 tRPC 路由集中注册，爆炸风险已显现

**现状**：29 个路由文件、35+ 子路由全部集中注册到 `server/routers.ts` 的 `appRouter`。从 v1.5→v1.9→V4.0→v3.1 逐步累积，且部分路由定义在 service 文件中（如 `device.service.ts` 中的 `deviceRouter`、`eventBus.service.ts` 中的 `eventBusRouter`），违反关注点分离。

| 路由文件 | 行数 | 版本来源 |
|:---|:---:|:---|
| database.router.ts | 1,320 | v1.5 |
| docker.router.ts | 551 | Docker 引擎 |
| observability.router.ts | 481 | 可观测性 |
| algorithm.router.ts | 469 | 算法赋能 |
| plugin.router.ts | 466 | 插件管理 |

**建议**：

1. 按 Bounded Context 分层路由：`platformRouter`、`dataRouter`、`algorithmRouter`、`cognitionRouter`
2. 将 service 文件中的路由定义迁移到 `api/` 目录
3. 单个路由文件超过 500 行时拆分为子路由

---

## 四、P2 — 功能缺失/治理不足

### 4.1 无中央 Event Schema Registry

**现状**：`kafka-topics.const.ts` 定义了 7 个命名空间、50+ topic（覆盖良好），但事件的 **payload schema** 完全依赖 TypeScript interface（`EventPayload` in `domain.ts`），无版本化、无向后兼容性校验。Proto 目录有 `buf.yaml` 和 8 个 proto 文件，但仅 `infra.proto` 定义了 4 个 Event 消息，其余 proto 文件无事件定义。

此外，认知层有独立的 `topics.ts`，与 `kafka-topics.const.ts` 形成平行 topic 体系，增加了维护复杂度。

**建议**：

1. 将所有 Kafka 事件的 payload 定义迁移到 proto 文件，使用 `buf` 工具链进行 schema 校验
2. 合并认知层 `topics.ts` 到统一的 `kafka-topics.const.ts`
3. 在 Kafka producer 端增加 schema 校验中间件

### 4.2 配置管理缺少动态热更新

**现状**：双层 Feature Flags 体系：

- `featureFlags.ts`：5 个外部服务开关（Airflow/Kafka Connect/ES/Flink/Grok），来源环境变量
- `moduleFeatureFlags.ts`：28 个业务模块开关，来源环境变量

两者均需重启生效，无动态热更新。模块开关粒度粗（仅 enabled/disabled），无灰度发布（百分比放量）、无 A/B 分组。

**建议**：

1. 引入配置中心（如 `ConfigCenter` 服务），支持 API 动态更新 + WebSocket 推送
2. 模块开关增加灰度粒度：`{ enabled: boolean, percentage: number, userGroups: string[] }`
3. 配置变更记录审计日志

### 4.3 认知闭环缺少数据回灌管道

**现状**：认知引擎的知识结晶器（`KnowledgeCrystallizer`）可以从认知结果中提取知识并存储，但：

1. 存储后端是 `InMemoryKnowledgeStore` → **重启丢失**
2. 无 KG→训练数据的回灌管道（知识无法反哺模型训练）
3. 无历史数据重放（replay）机制
4. 无系统级仿真（影子评估器仅做模型级 A/B 对比，不支持场景仿真）

**建议**：

1. 将 `InMemoryKnowledgeStore` 替换为持久化存储（MySQL 或 Redis）
2. 增加 `KnowledgeBackfillPipeline`：KG 知识 → 训练数据标注 → 模型再训练
3. 增加 `ScenarioSimulator`：基于历史数据重放的系统级仿真

### 4.4 认知层缺少神经世界模型和自我优化飞轮

**现状**：认知引擎 31 个文件中，零 `worldModel`/`neuralWorld` 引用，零 `selfOptimize`/`flywheel` 引用。Meta-Learner 仅做加权查询（置信度加权求和），无真正的在线学习或策略优化。

**影响**：认知层仍是"规则+统计"混合体，缺少深度学习预测能力。无法从运行经验中自动优化自身策略。

**建议**：

1. 短期：为 Meta-Learner 增加在线学习能力（如 Thompson Sampling 或 UCB 策略）
2. 中期：引入轻量级神经世界模型（如 LSTM/Transformer 时序预测）
3. 长期：构建自我优化飞轮（认知结果 → 评估 → 策略调整 → 认知参数更新）

### 4.5 插件与认知闭环完全隔离

**现状**：`plugin.sandbox.ts` 暴露的 API 中无认知相关接口。Champion-Challenger 和 Meta-Learner 中零 plugin 引用。插件无法参与模型竞赛或贡献学习经验。

**建议**：

1. 在沙箱 API 中增加 `cognition.submitPrediction()` 接口，允许插件参与 Champion-Challenger
2. 增加 `cognition.reportExperience()` 接口，允许插件向 Meta-Learner 贡献经验
3. 增加插件发现/分发机制（插件市场 MVP）

### 4.6 Schema Registry 极简，无版本化

**现状**：`schema-registry.service.ts` 仅 21 行，只做 `information_schema` 查询（列出表、查看列），无版本化、无 schema diff、无自动同步。

**建议**：增强为完整的 Schema Registry：

1. Schema 版本管理（每次迁移记录版本号）
2. Schema diff 工具（对比 Drizzle schema 与实际数据库）
3. 自动生成 ERD（基于 `relations.ts`）

### 4.7 ES 使用率极低，可考虑 ClickHouse 替代

**现状**：仅 3 个文件引用 Elasticsearch，且全部在 observability 模块（日志/搜索）。ClickHouse 已有 15 个文件引用，使用率远高于 ES。

**建议**：评估 ClickHouse 的全文搜索能力（`hasToken`/`ngramSearch`），如果满足日志搜索需求，可移除 ES 依赖，减少运维复杂度。

### 4.8 relations.ts 手动维护 129 张表关系

**现状**：`drizzle/relations.ts`（486 行）手动维护 129 张表的关系定义，`drizzle/schema.ts`（3,110 行）定义所有表结构。两个文件完全手动维护，无自动校验。

**建议**：

1. 增加 CI 校验脚本：自动检测 `schema.ts` 中的表是否都有对应的 `relations.ts` 定义
2. 考虑自动生成 `relations.ts`（基于外键约束推断）
3. 按域拆分 `schema.ts`：`schema/asset.ts`、`schema/algorithm.ts`、`schema/cognition.ts` 等

---

## 五、P3 — 优化建议/技术债

### 5.1 数据清洗是后置的，非前置

数据清洗服务（`cleanRuleService`/`cleanTaskService`）是入库后清洗，而非入库前拦截。建议在 Gateway Bridge 的 `validateMessage()` 中增加语义校验层（数值范围、时间戳合理性），实现"前置拦截 + 后置清洗"双保险。

### 5.2 ClickHouse 缺少跨设备关联宽表

当前 14 个物化视图都是单设备维度的聚合。缺少跨设备关联视图（如"同一产线所有设备的综合健康评分"），导致应用层需要多次查询后在内存中关联。

### 5.3 Drizzle 迁移命名无业务语义

`0000_strong_gravity.sql` 这类随机命名增加了排查难度。建议统一为 `NNNN-<业务描述>.sql` 格式。

### 5.4 插件缺少 RBAC 和动态资源限额

当前插件权限是全局列表（`PluginPermission` 类型），无角色分级。资源限额（`DEFAULT_RESOURCE_LIMITS`）是静态的，无法根据插件信任等级动态调整。

### 5.5 部分路由定义在 Service 文件中

`device.service.ts`、`eventBus.service.ts`、`knowledge.service.ts`、`model.service.ts` 等文件中直接定义了 tRPC router，违反关注点分离原则。应迁移到 `api/` 目录。

---

## 六、修复路线图

### 第一阶段：治理基础（1-2 周）

| 任务 | 优先级 | 预估工时 | 依赖 |
|:---|:---:|:---:|:---|
| 制定 Bounded Context Map 文档 | P0 | 8h | 无 |
| CI 增加 `drizzle-kit check` schema 校验 | P1 | 4h | 无 |
| Gateway Bridge 增加语义校验层 | P1 | 6h | 无 |
| ClickHouse 1h 视图添加 stddevState | P1 | 2h | 无 |
| 迁移命名规范化 | P3 | 2h | 无 |
| 合并认知层 topics.ts 到统一 topic 体系 | P2 | 4h | 无 |

### 第二阶段：架构重构（3-4 周）

| 任务 | 优先级 | 预估工时 | 依赖 |
|:---|:---:|:---:|:---|
| 引入 DataFederator 联邦查询层 | P0 | 24h | Bounded Context Map |
| 拆分 pipeline.engine.ts | P0 | 16h | Bounded Context Map |
| 拆分 algorithm.service.ts | P0 | 12h | Bounded Context Map |
| tRPC 路由分层重构 | P1 | 8h | Bounded Context Map |
| Service 文件中的路由迁移到 api/ | P3 | 4h | 路由分层 |
| 插件沙箱迁移到 isolated-vm | P1 | 16h | 无 |

### 第三阶段：认知增强（5-8 周）

| 任务 | 优先级 | 预估工时 | 依赖 |
|:---|:---:|:---:|:---|
| KnowledgeStore 持久化 | P2 | 8h | 无 |
| Event Schema Registry（proto 化） | P2 | 16h | 无 |
| 配置中心 + 动态热更新 | P2 | 12h | 无 |
| Meta-Learner 在线学习 | P2 | 16h | 无 |
| 插件认知接口 | P2 | 8h | 无 |
| 数据回灌管道 | P2 | 20h | KnowledgeStore 持久化 |
| 跨设备关联宽表 | P3 | 6h | 无 |
| Schema Registry 增强 | P2 | 8h | 无 |
| relations.ts 自动校验 | P3 | 4h | 无 |

### 第四阶段：高级能力（9-12 周）

| 任务 | 优先级 | 预估工时 | 依赖 |
|:---|:---:|:---:|:---|
| 轻量级神经世界模型 | P2 | 40h | Meta-Learner 在线学习 |
| 自我优化飞轮 | P2 | 32h | 神经世界模型 |
| 场景仿真器 | P2 | 24h | 数据回灌管道 |
| ES→ClickHouse 迁移评估 | P2 | 8h | 无 |
| 插件 RBAC + 动态资源限额 | P3 | 12h | 无 |
| 插件市场 MVP | P3 | 24h | 插件认知接口 |
| Wasm 沙箱评估 | P3 | 16h | isolated-vm 迁移 |

---

## 七、架构健康度评分

| 维度 | 评分 | 说明 |
|:---|:---:|:---|
| **数据一致性** | 4/10 | 零事务、Schema 漂移、数据校验不足 |
| **服务治理** | 3/10 | 无 DDD 边界、God Service、路由爆炸 |
| **事件驱动** | 6/10 | Topic 覆盖好，但无 Schema Registry |
| **认知引擎** | 7/10 | 架构完整，但缺数据回灌和自优化 |
| **插件系统** | 6/10 | 三层隔离好，但 vm 逃逸风险+无认知接口 |
| **配置管理** | 4/10 | 双层 Flag 存在，但无热更新+粒度粗 |
| **数据质量** | 4/10 | 后置清洗有，前置校验弱 |
| **Schema 治理** | 3/10 | 手动维护、已漂移、无自动校验 |
| **ClickHouse** | 7/10 | 14 个物化视图覆盖好，std_dev 有 bug |
| **可演进性** | 3/10 | 无联邦查询、无 DDD、路由耦合 |
| **综合** | **4.7/10** | 工程基础扎实，治理层严重不足 |

---

## 八、与首轮审计的对比

| 维度 | 首轮发现 | 本轮新增发现 |
|:---|:---|:---|
| 数据一致性 | 零事务、Redlock 未使用 | Schema 漂移已发生 2 次、relations.ts 手动维护 129 表 |
| Kafka | 分区策略合理 | 无 Event Schema Registry、认知层平行 topic 体系 |
| ClickHouse | std_dev=0 | 缺少跨设备关联宽表、ES 可替代 |
| 模型迭代 | 无持久化/版本管理 | Meta-Learner 仅加权查询、无在线学习 |
| LLM 协同 | 三子系统互不通信 | 推演处理器已集成 LLM（本轮修复） |
| KG 编排器 | 多步写入无事务 | 已事务化（本轮修复） |
| — | — | **新增**：联邦查询缺失、DDD 边界模糊、God Service |
| — | — | **新增**：插件安全逃逸风险、认知闭环不完整 |
| — | — | **新增**：配置管理无热更新、数据清洗后置 |
| — | — | **新增**：tRPC 路由爆炸、Schema Registry 极简 |

---

## 九、结论

西联平台在**功能广度**上表现出色（129 张表、31 个认知文件、50+ Kafka topic、三层插件沙箱），但在**架构治理深度**上存在系统性缺口。核心问题不是"缺少功能"，而是"缺少治理"——无联邦查询引擎、无 DDD 边界、无 Event Schema Registry、无配置中心、无数据回灌管道。

建议优先执行第一阶段（治理基础）和第二阶段（架构重构），在不增加新功能的前提下提升平台的可维护性和可演进性。第三、四阶段的认知增强可与业务需求并行推进。

> **核心原则**：先治理，后增长。在 God Service 和 Schema 漂移未解决之前，新增功能只会加速技术债积累。
